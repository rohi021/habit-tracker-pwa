<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <meta name="description" content="Complete student life management platform - study, assignments, expenses, wellness, and more">
    <meta name="theme-color" content="#0f172a" media="(prefers-color-scheme: dark)">
    <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
    
    <title>StudentOS | Complete Student Life Management</title>
    
    <!-- PWA -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiSGFiaXRPUyIsInNob3J0X25hbWUiOiJIYWJpdE9TIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMwZjE3MmEiLCJ0aGVtZV9jb2xvciI6IiM2MzY2ZjEifQ==">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“Š</text></svg>">
    
    <!-- Preload Critical Resources -->
    <link rel="preconnect" href="https://cdn.tailwindcss.com">
    <link rel="preconnect" href="https://unpkg.com">
    
    <!-- Dependencies -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        brand: { 50: '#eef2ff', 500: '#6366f1', 600: '#4f46e5', 900: '#312e81' }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'pulse-slow': 'pulse 3s infinite',
                    }
                }
            }
        }
    </script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        /* ==================== BASE STYLES ==================== */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        *, *::before, *::after {
            box-sizing: border-box;
        }
        
        html {
            font-family: 'Inter', system-ui, sans-serif;
            -webkit-font-smoothing: antialiased;
            scroll-behavior: smooth;
        }
        
        body {
            margin: 0;
            background: #0f172a;
            color: #f8fafc;
            min-height: 100dvh;
            overscroll-behavior: none;
        }
        
        /* Light mode */
        body.light {
            background: #f8fafc;
            color: #0f172a;
        }
        
        /* ==================== ACCESSIBILITY ==================== */
        /* Focus visible for keyboard users */
        :focus-visible {
            outline: 2px solid #6366f1;
            outline-offset: 2px;
        }
        
        /* Reduced motion */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* High contrast mode */
        @media (prefers-contrast: high) {
            .habit-card { border-width: 2px !important; }
            button { border: 2px solid currentColor !important; }
        }
        
        /* ==================== COMPONENT STYLES ==================== */
        .glass {
            background: rgba(15, 23, 42, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }
        
        body.light .glass {
            background: rgba(255, 255, 255, 0.9);
        }
        
        /* Touch-friendly targets (minimum 44x44px per WCAG) */
        .touch-target {
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Skip link for accessibility */
        .skip-link {
            position: absolute;
            top: -100%;
            left: 0;
            background: #6366f1;
            color: white;
            padding: 8px 16px;
            z-index: 9999;
            transition: top 0.3s;
        }
        .skip-link:focus {
            top: 0;
        }
        
        /* Progress ring animation */
        .progress-ring-circle {
            transition: stroke-dashoffset 0.35s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }
        
        /* Skeleton loading */
        .skeleton {
            background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
            background-size: 200% 100%;
            animation: skeleton 1.5s infinite;
        }
        @keyframes skeleton {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Toast notifications */
        .toast-container {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: none;
        }
        .toast {
            padding: 12px 20px;
            background: #1e293b;
            border: 1px solid #334155;
            border-radius: 12px;
            color: white;
            font-size: 14px;
            animation: slideUp 0.3s ease-out;
            pointer-events: auto;
        }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        /* Print styles */
        @media print {
            body { background: white; color: black; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body>
    <!-- Skip Link for Accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <div id="root" role="application" aria-label="HabitOS Habit Tracker"></div>
    
    <!-- Toast Container -->
    <div id="toast-container" class="toast-container" role="status" aria-live="polite"></div>

    <script type="text/babel">
    // ============================================================================
    // HABITOS: PRODUCTION-GRADE HABIT TRACKING SYSTEM
    // ============================================================================
    // Architecture: Clean, modular, documented, testable
    // Performance: Optimized renders, debounced persistence, memoized calculations
    // Accessibility: WCAG 2.1 AA compliant, screen reader friendly
    // Analytics: Real statistical algorithms, not fake insights
    // ============================================================================

    const { 
        useState, useEffect, useMemo, useRef, useCallback, 
        useReducer, createContext, useContext, memo, 
        Suspense, lazy, useId, useSyncExternalStore
    } = React;

    // ============================================================================
    // SECTION 1: CONFIGURATION & CONSTANTS
    // ============================================================================
    
    /**
     * Application configuration
     * @constant
     */
    const CONFIG = Object.freeze({
        APP_NAME: 'StudentOS',
        VERSION: '2.0.0',
        STORAGE_KEY: 'studentos-v2', // Changed from habitos-v2 for migration
        MAX_UNDO_STACK: 30,
        DEBOUNCE_MS: 500,
        MIN_DATA_POINTS_FOR_INSIGHTS: 7,
        TOAST_DURATION_MS: 3000,
        COLORS: Object.freeze({
            indigo: { bg: '#6366f1', light: '#818cf8', dark: '#4f46e5' },
            emerald: { bg: '#10b981', light: '#34d399', dark: '#059669' },
            amber: { bg: '#f59e0b', light: '#fbbf24', dark: '#d97706' },
            rose: { bg: '#f43f5e', light: '#fb7185', dark: '#e11d48' },
            purple: { bg: '#8b5cf6', light: '#a78bfa', dark: '#7c3aed' },
            cyan: { bg: '#06b6d4', light: '#22d3ee', dark: '#0891b2' },
            sky: { bg: '#0ea5e9', light: '#38bdf8', dark: '#0284c7' },
            orange: { bg: '#f97316', light: '#fb923c', dark: '#ea580c' },
        }),
        CATEGORIES: Object.freeze(['Health', 'Productivity', 'Learning', 'Fitness', 'Mindfulness', 'Social', 'Finance', 'Creative']),
        QUADRANTS: Object.freeze({
            q1: { name: 'Do First', description: 'Urgent & Important', color: 'rose' },
            q2: { name: 'Schedule', description: 'Not Urgent but Important', color: 'purple' },
            q3: { name: 'Delegate', description: 'Urgent but Not Important', color: 'amber' },
            q4: { name: 'Eliminate', description: 'Neither Urgent nor Important', color: 'slate' },
        }),
        // XP and Level System
        XP_PER_LEVEL: 100, // Level = sqrt(XP / 100) + 1
        MAX_LEVEL: 50,
        LEVEL_TITLES: Object.freeze({
            1: 'Freshman',
            5: 'Student',
            10: 'Scholar',
            15: 'Achiever',
            20: 'Expert',
            25: 'Master',
            30: 'Sage',
            35: 'Virtuoso',
            40: 'Legend',
            50: 'Valedictorian'
        }),
        // Mood emojis
        MOODS: Object.freeze({
            veryHappy: 'ðŸ˜„',
            happy: 'ðŸ˜Š',
            neutral: 'ðŸ˜',
            sad: 'ðŸ˜”',
            verySad: 'ðŸ˜¢'
        }),
    });

    // ============================================================================
    // SECTION 2: UTILITY FUNCTIONS (Pure, Testable)
    // ============================================================================

    /**
     * Date utilities
     */
    const DateUtils = {
        /**
         * Get ISO date string for a given date
         * @param {Date} [date=new Date()] - The date to format
         * @returns {string} ISO date string (YYYY-MM-DD)
         */
        toKey: (date = new Date()) => date.toISOString().split('T')[0],
        
        /**
         * Get the number of days in a month
         * @param {number} year - Full year
         * @param {number} month - Month (0-indexed)
         * @returns {number} Days in the month
         */
        daysInMonth: (year, month) => new Date(year, month + 1, 0).getDate(),
        
        /**
         * Get date from N days ago
         * @param {number} days - Number of days ago
         * @returns {Date} The date
         */
        daysAgo: (days) => {
            const d = new Date();
            d.setDate(d.getDate() - days);
            return d;
        },
        
        /**
         * Check if a date is today
         * @param {string} dateKey - ISO date string
         * @returns {boolean}
         */
        isToday: (dateKey) => dateKey === DateUtils.toKey(),
        
        /**
         * Get day of week (0 = Sunday, 6 = Saturday)
         * @param {string} dateKey - ISO date string
         * @returns {number}
         */
        dayOfWeek: (dateKey) => new Date(dateKey).getDay(),
        
        /**
         * Format date for display
         * @param {Date|string} date - Date to format
         * @param {Intl.DateTimeFormatOptions} options - Format options
         * @returns {string}
         */
        format: (date, options = { month: 'short', day: 'numeric' }) => {
            const d = typeof date === 'string' ? new Date(date) : date;
            return d.toLocaleDateString('en-US', options);
        }
    };

    /**
     * Statistical utilities for REAL insights (not fake!)
     */
    const StatsUtils = {
        /**
         * Calculate arithmetic mean
         * @param {number[]} values
         * @returns {number}
         */
        mean: (values) => {
            if (values.length === 0) return 0;
            return values.reduce((a, b) => a + b, 0) / values.length;
        },
        
        /**
         * Calculate standard deviation
         * @param {number[]} values
         * @returns {number}
         */
        stdDev: (values) => {
            if (values.length < 2) return 0;
            const avg = StatsUtils.mean(values);
            const squareDiffs = values.map(v => Math.pow(v - avg, 2));
            return Math.sqrt(StatsUtils.mean(squareDiffs));
        },
        
        /**
         * Calculate Pearson correlation coefficient between two arrays
         * @param {number[]} x - First array
         * @param {number[]} y - Second array
         * @returns {number} Correlation (-1 to 1)
         */
        pearsonCorrelation: (x, y) => {
            if (x.length !== y.length || x.length < 3) return 0;
            
            const n = x.length;
            const sumX = x.reduce((a, b) => a + b, 0);
            const sumY = y.reduce((a, b) => a + b, 0);
            const sumXY = x.reduce((total, xi, i) => total + xi * y[i], 0);
            const sumX2 = x.reduce((total, xi) => total + xi * xi, 0);
            const sumY2 = y.reduce((total, yi) => total + yi * yi, 0);
            
            const numerator = n * sumXY - sumX * sumY;
            const denominator = Math.sqrt(
                (n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY)
            );
            
            if (denominator === 0) return 0;
            return numerator / denominator;
        },
        
        /**
         * Calculate linear regression slope (trend direction)
         * @param {number[]} values - Values over time
         * @returns {{ slope: number, direction: 'up' | 'down' | 'stable' }}
         */
        trend: (values) => {
            if (values.length < 3) return { slope: 0, direction: 'stable' };
            
            const n = values.length;
            const xMean = (n - 1) / 2;
            const yMean = StatsUtils.mean(values);
            
            let numerator = 0;
            let denominator = 0;
            
            for (let i = 0; i < n; i++) {
                numerator += (i - xMean) * (values[i] - yMean);
                denominator += (i - xMean) * (i - xMean);
            }
            
            const slope = denominator !== 0 ? numerator / denominator : 0;
            
            const direction = slope > 0.05 ? 'up' : slope < -0.05 ? 'down' : 'stable';
            
            return { slope, direction };
        },
        
        /**
         * Detect anomalies using Z-score
         * @param {number[]} values
         * @param {number} [threshold=2] - Z-score threshold
         * @returns {number[]} Indices of anomalies
         */
        detectAnomalies: (values, threshold = 2) => {
            const mean = StatsUtils.mean(values);
            const std = StatsUtils.stdDev(values);
            
            if (std === 0) return [];
            
            return values
                .map((v, i) => ({ index: i, zScore: Math.abs((v - mean) / std) }))
                .filter(({ zScore }) => zScore > threshold)
                .map(({ index }) => index);
        },
        
        /**
         * Calculate moving average
         * @param {number[]} values
         * @param {number} window - Window size
         * @returns {number[]}
         */
        movingAverage: (values, window = 7) => {
            return values.map((_, i, arr) => {
                const start = Math.max(0, i - window + 1);
                const slice = arr.slice(start, i + 1);
                return StatsUtils.mean(slice);
            });
        }
    };

    /**
     * Habit-specific calculations
     */
    const HabitUtils = {
        /**
         * Calculate current streak for a habit
         * @param {Object} data - Habit completion data { [dateKey]: boolean }
         * @returns {number} Current streak length
         */
        calculateStreak: (data) => {
            if (!data || Object.keys(data).length === 0) return 0;
            
            let streak = 0;
            let currentDate = new Date();
            
            // Check if today is completed
            const todayKey = DateUtils.toKey(currentDate);
            if (!data[todayKey]) {
                // Check yesterday - allow one day grace
                currentDate.setDate(currentDate.getDate() - 1);
            }
            
            // Count consecutive days
            for (let i = 0; i < 365; i++) {
                const key = DateUtils.toKey(currentDate);
                if (data[key]) {
                    streak++;
                    currentDate.setDate(currentDate.getDate() - 1);
                } else {
                    break;
                }
            }
            
            return streak;
        },
        
        /**
         * Calculate longest streak ever
         * @param {Object} data - Habit completion data
         * @returns {number}
         */
        calculateLongestStreak: (data) => {
            if (!data) return 0;
            
            const dates = Object.keys(data).sort();
            if (dates.length === 0) return 0;
            
            let maxStreak = 1;
            let currentStreak = 1;
            
            for (let i = 1; i < dates.length; i++) {
                const prevDate = new Date(dates[i - 1]);
                const currDate = new Date(dates[i]);
                const diffDays = Math.round((currDate - prevDate) / (1000 * 60 * 60 * 24));
                
                if (diffDays === 1) {
                    currentStreak++;
                    maxStreak = Math.max(maxStreak, currentStreak);
                } else {
                    currentStreak = 1;
                }
            }
            
            return maxStreak;
        },
        
        /**
         * Calculate completion rate for a time period
         * @param {Object} data - Habit completion data
         * @param {number} days - Number of days to analyze
         * @returns {number} Completion rate (0-100)
         */
        calculateCompletionRate: (data, days = 30) => {
            if (!data) return 0;
            
            let completed = 0;
            const today = new Date();
            
            for (let i = 0; i < days; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const key = DateUtils.toKey(date);
                if (data[key]) completed++;
            }
            
            return Math.round((completed / days) * 100);
        },
        
        /**
         * Get completion data as array for analysis
         * @param {Object} data - Habit completion data
         * @param {number} days - Number of days
         * @returns {number[]} Array of 1s (completed) and 0s (not completed)
         */
        getCompletionArray: (data, days = 30) => {
            const result = [];
            const today = new Date();
            
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                const key = DateUtils.toKey(date);
                result.push(data?.[key] ? 1 : 0);
            }
            
            return result;
        },
        
        /**
         * Find best performing day of week
         * @param {Object} data - Habit completion data
         * @returns {{ day: number, rate: number } | null}
         */
        findBestDay: (data) => {
            if (!data) return null;
            
            const dayStats = [0, 0, 0, 0, 0, 0, 0].map(() => ({ completed: 0, total: 0 }));
            
            Object.keys(data).forEach(key => {
                const day = DateUtils.dayOfWeek(key);
                dayStats[day].total++;
                if (data[key]) dayStats[day].completed++;
            });
            
            let bestDay = 0;
            let bestRate = 0;
            
            dayStats.forEach((stat, day) => {
                if (stat.total > 0) {
                    const rate = stat.completed / stat.total;
                    if (rate > bestRate) {
                        bestRate = rate;
                        bestDay = day;
                    }
                }
            });
            
            return { day: bestDay, rate: Math.round(bestRate * 100) };
        },
        
        /**
         * Find worst performing day of week
         * @param {Object} data - Habit completion data
         * @returns {{ day: number, rate: number } | null}
         */
        findWorstDay: (data) => {
            if (!data) return null;
            
            const dayStats = [0, 0, 0, 0, 0, 0, 0].map(() => ({ completed: 0, total: 0 }));
            
            Object.keys(data).forEach(key => {
                const day = DateUtils.dayOfWeek(key);
                dayStats[day].total++;
                if (data[key]) dayStats[day].completed++;
            });
            
            let worstDay = 0;
            let worstRate = 1;
            
            dayStats.forEach((stat, day) => {
                if (stat.total >= 2) { // Need at least 2 data points
                    const rate = stat.completed / stat.total;
                    if (rate < worstRate) {
                        worstRate = rate;
                        worstDay = day;
                    }
                }
            });
            
            return { day: worstDay, rate: Math.round(worstRate * 100) };
        }
    };

    // ============================================================================
    // SECTION 3: ANALYTICS ENGINE (Real AI/ML-like Insights)
    // ============================================================================

    /**
     * Analytics engine that generates REAL insights from user data
     */
    const AnalyticsEngine = {
        /**
         * Generate all insights for current state
         * @param {Object} habits - All habits
         * @param {string[]} habitOrder - Ordered habit IDs
         * @returns {Object[]} Array of insight objects
         */
        generateInsights: (habits, habitOrder) => {
            const insights = [];
            const activeHabits = habitOrder
                .map(id => habits[id])
                .filter(h => h && !h.archived);
            
            if (activeHabits.length === 0) {
                return [{
                    id: 'empty',
                    type: 'info',
                    icon: 'ðŸ“',
                    title: 'Get Started',
                    message: 'Add your first habit to begin tracking.',
                    priority: 1
                }];
            }
            
            // 1. Find correlations between habits
            const correlationInsights = AnalyticsEngine.findCorrelations(activeHabits);
            insights.push(...correlationInsights);
            
            // 2. Detect trends
            const trendInsights = AnalyticsEngine.analyzeTrends(activeHabits);
            insights.push(...trendInsights);
            
            // 3. Find weak days
            const dayInsights = AnalyticsEngine.analyzeWeekdays(activeHabits);
            insights.push(...dayInsights);
            
            // 4. Streak analysis
            const streakInsights = AnalyticsEngine.analyzeStreaks(activeHabits);
            insights.push(...streakInsights);
            
            // 5. Overall performance
            const performanceInsights = AnalyticsEngine.analyzePerformance(activeHabits);
            insights.push(...performanceInsights);
            
            // Sort by priority and return top insights
            return insights
                .filter(i => i !== null)
                .sort((a, b) => (b.priority || 0) - (a.priority || 0))
                .slice(0, 5);
        },
        
        /**
         * Find correlations between habits
         * @param {Object[]} habits
         * @returns {Object[]}
         */
        findCorrelations: (habits) => {
            const insights = [];
            
            if (habits.length < 2) return insights;
            
            for (let i = 0; i < habits.length; i++) {
                for (let j = i + 1; j < habits.length; j++) {
                    const h1 = habits[i];
                    const h2 = habits[j];
                    
                    const arr1 = HabitUtils.getCompletionArray(h1.data, 14);
                    const arr2 = HabitUtils.getCompletionArray(h2.data, 14);
                    
                    if (arr1.filter(x => x).length < 3 || arr2.filter(x => x).length < 3) continue;
                    
                    const correlation = StatsUtils.pearsonCorrelation(arr1, arr2);
                    
                    if (correlation > 0.6) {
                        insights.push({
                            id: `corr-${h1.id}-${h2.id}`,
                            type: 'correlation',
                            icon: 'ðŸ”—',
                            title: 'Strong Habit Link Detected',
                            message: `"${h1.name}" and "${h2.name}" are completed together ${Math.round(correlation * 100)}% of the time. Consider stacking them!`,
                            priority: 8,
                            habitIds: [h1.id, h2.id]
                        });
                    } else if (correlation < -0.4) {
                        insights.push({
                            id: `neg-corr-${h1.id}-${h2.id}`,
                            type: 'warning',
                            icon: 'âš ï¸',
                            title: 'Competing Habits',
                            message: `"${h1.name}" and "${h2.name}" seem to compete. When you do one, you often skip the other.`,
                            priority: 6,
                            habitIds: [h1.id, h2.id]
                        });
                    }
                }
            }
            
            return insights;
        },
        
        /**
         * Analyze trends for each habit
         * @param {Object[]} habits
         * @returns {Object[]}
         */
        analyzeTrends: (habits) => {
            const insights = [];
            
            habits.forEach(habit => {
                const completionArray = HabitUtils.getCompletionArray(habit.data, 14);
                const weeklyTotals = [
                    completionArray.slice(0, 7).filter(x => x).length,
                    completionArray.slice(7, 14).filter(x => x).length
                ];
                
                const change = weeklyTotals[1] - weeklyTotals[0];
                const percentChange = weeklyTotals[0] > 0 
                    ? Math.round((change / weeklyTotals[0]) * 100)
                    : weeklyTotals[1] > 0 ? 100 : 0;
                
                if (percentChange >= 30) {
                    insights.push({
                        id: `trend-up-${habit.id}`,
                        type: 'success',
                        icon: 'ðŸ“ˆ',
                        title: 'Improving Trend',
                        message: `"${habit.name}" is up ${percentChange}% this week vs last week. Great momentum!`,
                        priority: 7
                    });
                } else if (percentChange <= -30) {
                    insights.push({
                        id: `trend-down-${habit.id}`,
                        type: 'warning',
                        icon: 'ðŸ“‰',
                        title: 'Declining Trend',
                        message: `"${habit.name}" is down ${Math.abs(percentChange)}% this week. What's blocking you?`,
                        priority: 9,
                        urgent: true
                    });
                }
            });
            
            return insights;
        },
        
        /**
         * Analyze performance by day of week
         * @param {Object[]} habits
         * @returns {Object[]}
         */
        analyzeWeekdays: (habits) => {
            const insights = [];
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            
            // Aggregate across all habits
            const dayStats = Array(7).fill(null).map(() => ({ completed: 0, total: 0 }));
            
            habits.forEach(habit => {
                Object.keys(habit.data || {}).forEach(key => {
                    const day = DateUtils.dayOfWeek(key);
                    dayStats[day].total++;
                    if (habit.data[key]) dayStats[day].completed++;
                });
            });
            
            // Find worst day
            let worstDay = -1;
            let worstRate = 1;
            
            dayStats.forEach((stat, day) => {
                if (stat.total >= 4) { // Need enough data
                    const rate = stat.completed / stat.total;
                    if (rate < worstRate) {
                        worstRate = rate;
                        worstDay = day;
                    }
                }
            });
            
            if (worstDay >= 0 && worstRate < 0.5) {
                insights.push({
                    id: 'worst-day',
                    type: 'warning',
                    icon: 'ðŸ“…',
                    title: 'Weak Day Detected',
                    message: `${dayNames[worstDay]}s are your weakest day (${Math.round(worstRate * 100)}% completion). Plan easier habits for this day.`,
                    priority: 6
                });
            }
            
            // Find best day
            let bestDay = -1;
            let bestRate = 0;
            
            dayStats.forEach((stat, day) => {
                if (stat.total >= 4) {
                    const rate = stat.completed / stat.total;
                    if (rate > bestRate) {
                        bestRate = rate;
                        bestDay = day;
                    }
                }
            });
            
            if (bestDay >= 0 && bestRate > 0.8) {
                insights.push({
                    id: 'best-day',
                    type: 'success',
                    icon: 'ðŸ†',
                    title: 'Power Day',
                    message: `${dayNames[bestDay]}s are your strongest day (${Math.round(bestRate * 100)}% completion). Schedule important habits here.`,
                    priority: 4
                });
            }
            
            return insights;
        },
        
        /**
         * Analyze streaks
         * @param {Object[]} habits
         * @returns {Object[]}
         */
        analyzeStreaks: (habits) => {
            const insights = [];
            
            habits.forEach(habit => {
                const streak = HabitUtils.calculateStreak(habit.data);
                const longestStreak = HabitUtils.calculateLongestStreak(habit.data);
                
                // About to beat record
                if (streak > 0 && streak === longestStreak && streak >= 7) {
                    insights.push({
                        id: `record-${habit.id}`,
                        type: 'success',
                        icon: 'ðŸ”¥',
                        title: 'Record Streak!',
                        message: `"${habit.name}" is at ${streak} days - your longest ever! Keep it going!`,
                        priority: 10
                    });
                }
                
                // Streak at risk (Day 2-3 is most fragile)
                if (streak >= 2 && streak <= 3) {
                    const todayKey = DateUtils.toKey();
                    if (!habit.data?.[todayKey]) {
                        insights.push({
                            id: `risk-${habit.id}`,
                            type: 'urgent',
                            icon: 'ðŸš¨',
                            title: 'Streak at Risk!',
                            message: `"${habit.name}" streak is fragile (day ${streak + 1}). Complete it now before the day ends!`,
                            priority: 10,
                            urgent: true,
                            habitId: habit.id
                        });
                    }
                }
                
                // Long streak milestone
                if (streak > 0 && [7, 14, 21, 30, 60, 90, 100, 365].includes(streak)) {
                    insights.push({
                        id: `milestone-${habit.id}-${streak}`,
                        type: 'celebration',
                        icon: 'ðŸŽ‰',
                        title: 'Milestone Reached!',
                        message: `"${habit.name}" hit ${streak} days! ${streak >= 21 ? "It's becoming automatic!" : "Keep building!"}`,
                        priority: 5
                    });
                }
            });
            
            return insights;
        },
        
        /**
         * Analyze overall performance
         * @param {Object[]} habits
         * @returns {Object[]}
         */
        analyzePerformance: (habits) => {
            const insights = [];
            
            if (habits.length === 0) return insights;
            
            // Calculate overall completion rate
            let totalCompleted = 0;
            let totalPossible = 0;
            
            habits.forEach(habit => {
                for (let i = 0; i < 7; i++) {
                    const key = DateUtils.toKey(DateUtils.daysAgo(i));
                    totalPossible++;
                    if (habit.data?.[key]) totalCompleted++;
                }
            });
            
            const weeklyRate = Math.round((totalCompleted / totalPossible) * 100);
            
            if (weeklyRate >= 90) {
                insights.push({
                    id: 'excellent-week',
                    type: 'celebration',
                    icon: 'ðŸŒŸ',
                    title: 'Excellent Week!',
                    message: `${weeklyRate}% completion rate this week. You're in the top tier of habit builders!`,
                    priority: 3
                });
            } else if (weeklyRate < 30) {
                insights.push({
                    id: 'recovery-needed',
                    type: 'info',
                    icon: 'ðŸ’ª',
                    title: 'Recovery Mode',
                    message: `Tough week (${weeklyRate}%). That's okay! Start with just ONE habit today to rebuild momentum.`,
                    priority: 8
                });
            }
            
            return insights;
        }
    };

    // ============================================================================
    // SECTION 4: STATE MANAGEMENT
    // ============================================================================

    /**
     * Initial application state
     */
    const createInitialState = () => ({
        // Core data - Habits (existing)
        habits: {},
        habitOrder: [],
        
        // UI state
        view: 'dashboard',
        selectedHabit: null,
        isLoading: true,
        
        // Focus mode (existing - now part of study)
        focusMode: {
            active: false,
            habitId: null,
            startTime: null,
            duration: 25 * 60 // 25 minutes default
        },
        
        // ===== NEW: Study Session Tracker =====
        studySessions: [], // { id, subject, startTime, endTime, duration, notes, date, type: 'regular'|'pomodoro' }
        studyGoal: { daily: 120, weekly: 600 }, // minutes
        subjects: ['Math', 'Science', 'English', 'History', 'Computer Science', 'Literature', 'Physics', 'Chemistry', 'Biology', 'Other'],
        activeStudySession: null, // { subject, startTime, type, pomodoroCount, breakStartTime }
        
        // ===== NEW: Assignments & Exams =====
        assignments: [], // { id, title, subject, dueDate, priority, status, grade, type: 'assignment'|'exam', prepProgress, topics, createdAt }
        
        // ===== NEW: Expenses =====
        expenses: [], // { id, amount, category, description, date }
        monthlyBudget: 5000,
        expenseCategories: ['Food', 'Transport', 'Books', 'Entertainment', 'Subscriptions', 'Health', 'Other'],
        
        // ===== NEW: Sleep & Wellness =====
        sleepLog: [], // { id, date, bedtime, wakeTime, hours, quality }
        waterLog: {}, // { [dateKey]: glasses }
        exerciseLog: [], // { id, date, type, duration, notes }
        moodLog: {}, // { [dateKey]: { mood, energy, note } }
        waterGoal: 8, // glasses per day
        sleepGoal: 8, // hours per night
        
        // ===== NEW: Goals with Milestones =====
        goals: [], // { id, title, description, category, targetDate, milestones: [{text, done}], createdAt }
        goalCategories: ['Academic', 'Health', 'Financial', 'Personal', 'Career'],
        
        // ===== NEW: Timetable =====
        timetable: [], // { id, subject, day, startTime, endTime, room, color, notes }
        
        // ===== NEW: Journal =====
        journalEntries: [], // { id, date, content, mood, energy, gratitude, tags, wordCount }
        
        // ===== Gamification (Enhanced) =====
        streakFreezes: 2,
        totalPoints: 0,
        xp: 0,
        level: 1,
        achievements: [], // earned achievement IDs
        dailyChallenges: [], // { id, text, type, target, progress, completed, date, xpReward }
        
        // Settings (Enhanced)
        settings: {
            theme: 'dark',
            soundEnabled: true,
            hapticEnabled: true,
            reminderTime: '21:00',
            weekStartsOn: 0, // 0 = Sunday
            // New settings
            studyReminderEnabled: true,
            dailyStudyGoal: 120, // minutes
            monthlyBudget: 5000,
            waterGoal: 8,
            sleepGoal: 8,
            journalReminderEnabled: true
        },
        
        // Undo/Redo
        undoStack: [],
        redoStack: [],
        
        // Meta
        lastSyncedAt: null,
        appVersion: '2.0.0' // Updated for StudentOS
    });

    /**
     * Action types enum
     */
    const ActionTypes = Object.freeze({
        // Habit actions (existing)
        ADD_HABIT: 'ADD_HABIT',
        UPDATE_HABIT: 'UPDATE_HABIT',
        DELETE_HABIT: 'DELETE_HABIT',
        TOGGLE_HABIT: 'TOGGLE_HABIT',
        REORDER_HABITS: 'REORDER_HABITS',
        
        // Focus mode (existing)
        START_FOCUS: 'START_FOCUS',
        END_FOCUS: 'END_FOCUS',
        
        // Study Session Tracker
        START_STUDY_SESSION: 'START_STUDY_SESSION',
        END_STUDY_SESSION: 'END_STUDY_SESSION',
        DELETE_STUDY_SESSION: 'DELETE_STUDY_SESSION',
        UPDATE_STUDY_GOAL: 'UPDATE_STUDY_GOAL',
        
        // Assignments & Exams
        ADD_ASSIGNMENT: 'ADD_ASSIGNMENT',
        UPDATE_ASSIGNMENT: 'UPDATE_ASSIGNMENT',
        DELETE_ASSIGNMENT: 'DELETE_ASSIGNMENT',
        
        // Expenses
        ADD_EXPENSE: 'ADD_EXPENSE',
        UPDATE_EXPENSE: 'UPDATE_EXPENSE',
        DELETE_EXPENSE: 'DELETE_EXPENSE',
        SET_MONTHLY_BUDGET: 'SET_MONTHLY_BUDGET',
        
        // Wellness
        LOG_SLEEP: 'LOG_SLEEP',
        DELETE_SLEEP_LOG: 'DELETE_SLEEP_LOG',
        LOG_WATER: 'LOG_WATER',
        LOG_EXERCISE: 'LOG_EXERCISE',
        DELETE_EXERCISE: 'DELETE_EXERCISE',
        LOG_MOOD: 'LOG_MOOD',
        
        // Goals
        ADD_GOAL: 'ADD_GOAL',
        UPDATE_GOAL: 'UPDATE_GOAL',
        DELETE_GOAL: 'DELETE_GOAL',
        TOGGLE_MILESTONE: 'TOGGLE_MILESTONE',
        
        // Timetable
        ADD_TIMETABLE_ENTRY: 'ADD_TIMETABLE_ENTRY',
        UPDATE_TIMETABLE_ENTRY: 'UPDATE_TIMETABLE_ENTRY',
        DELETE_TIMETABLE_ENTRY: 'DELETE_TIMETABLE_ENTRY',
        
        // Journal
        ADD_JOURNAL_ENTRY: 'ADD_JOURNAL_ENTRY',
        UPDATE_JOURNAL_ENTRY: 'UPDATE_JOURNAL_ENTRY',
        DELETE_JOURNAL_ENTRY: 'DELETE_JOURNAL_ENTRY',
        
        // Gamification (Enhanced)
        USE_STREAK_FREEZE: 'USE_STREAK_FREEZE',
        ADD_POINTS: 'ADD_POINTS',
        ADD_XP: 'ADD_XP',
        EARN_ACHIEVEMENT: 'EARN_ACHIEVEMENT',
        GENERATE_DAILY_CHALLENGES: 'GENERATE_DAILY_CHALLENGES',
        COMPLETE_CHALLENGE: 'COMPLETE_CHALLENGE',
        
        // UI
        SET_VIEW: 'SET_VIEW',
        SET_SELECTED_HABIT: 'SET_SELECTED_HABIT',
        SET_LOADING: 'SET_LOADING',
        
        // Settings
        UPDATE_SETTINGS: 'UPDATE_SETTINGS',
        
        // Undo/Redo
        UNDO: 'UNDO',
        REDO: 'REDO',
        
        // Persistence
        LOAD_STATE: 'LOAD_STATE',
        RESET_STATE: 'RESET_STATE'
    });

    /**
     * State reducer
     * @param {Object} state - Current state
     * @param {Object} action - Action to perform
     * @returns {Object} New state
     */
    function appReducer(state, action) {
        const { type, payload } = action;
        
        // Helper to push to undo stack
        const withUndo = (newState) => ({
            ...newState,
            undoStack: [...state.undoStack.slice(-CONFIG.MAX_UNDO_STACK), {
                habits: state.habits,
                habitOrder: state.habitOrder
            }],
            redoStack: []
        });
        
        switch (type) {
            case ActionTypes.ADD_HABIT: {
                const id = crypto.randomUUID();
                const newHabit = {
                    id,
                    name: payload.name.trim(),
                    color: payload.color || 'indigo',
                    category: payload.category || 'General',
                    quadrant: payload.quadrant || 'q2',
                    archived: false,
                    createdAt: new Date().toISOString(),
                    data: {}
                };
                
                return withUndo({
                    ...state,
                    habits: { ...state.habits, [id]: newHabit },
                    habitOrder: [...state.habitOrder, id]
                });
            }
            
            case ActionTypes.UPDATE_HABIT: {
                const { id, updates } = payload;
                if (!state.habits[id]) return state;
                
                return withUndo({
                    ...state,
                    habits: {
                        ...state.habits,
                        [id]: { ...state.habits[id], ...updates }
                    }
                });
            }
            
            case ActionTypes.DELETE_HABIT: {
                const { id } = payload;
                const { [id]: deleted, ...remainingHabits } = state.habits;
                
                return withUndo({
                    ...state,
                    habits: remainingHabits,
                    habitOrder: state.habitOrder.filter(hid => hid !== id)
                });
            }
            
            case ActionTypes.TOGGLE_HABIT: {
                const { id, date = DateUtils.toKey() } = payload;
                const habit = state.habits[id];
                if (!habit) return state;
                
                const wasCompleted = !!habit.data?.[date];
                const newData = { ...habit.data };
                
                if (wasCompleted) {
                    delete newData[date];
                } else {
                    newData[date] = true;
                    
                    // Celebration effect
                    if (typeof confetti !== 'undefined') {
                        confetti({
                            particleCount: 50,
                            spread: 60,
                            origin: { y: 0.7 },
                            colors: [CONFIG.COLORS[habit.color]?.bg || '#6366f1', '#ffffff']
                        });
                    }
                }
                
                return withUndo({
                    ...state,
                    habits: {
                        ...state.habits,
                        [id]: { ...habit, data: newData }
                    },
                    totalPoints: state.totalPoints + (wasCompleted ? -10 : 10)
                });
            }
            
            case ActionTypes.REORDER_HABITS: {
                return withUndo({
                    ...state,
                    habitOrder: payload.order
                });
            }
            
            case ActionTypes.START_FOCUS: {
                return {
                    ...state,
                    focusMode: {
                        active: true,
                        habitId: payload.habitId,
                        startTime: Date.now(),
                        duration: payload.duration || 25 * 60
                    }
                };
            }
            
            case ActionTypes.END_FOCUS: {
                return {
                    ...state,
                    focusMode: {
                        active: false,
                        habitId: null,
                        startTime: null,
                        duration: 25 * 60
                    }
                };
            }
            
            case ActionTypes.USE_STREAK_FREEZE: {
                if (state.streakFreezes <= 0) return state;
                return { ...state, streakFreezes: state.streakFreezes - 1 };
            }
            
            case ActionTypes.SET_VIEW: {
                return { ...state, view: payload };
            }
            
            case ActionTypes.SET_LOADING: {
                return { ...state, isLoading: payload };
            }
            
            case ActionTypes.UPDATE_SETTINGS: {
                return {
                    ...state,
                    settings: { ...state.settings, ...payload }
                };
            }
            
            case ActionTypes.UNDO: {
                if (state.undoStack.length === 0) return state;
                const previous = state.undoStack[state.undoStack.length - 1];
                
                return {
                    ...state,
                    habits: previous.habits,
                    habitOrder: previous.habitOrder,
                    undoStack: state.undoStack.slice(0, -1),
                    redoStack: [{
                        habits: state.habits,
                        habitOrder: state.habitOrder
                    }, ...state.redoStack]
                };
            }
            
            case ActionTypes.REDO: {
                if (state.redoStack.length === 0) return state;
                const next = state.redoStack[0];
                
                return {
                    ...state,
                    habits: next.habits,
                    habitOrder: next.habitOrder,
                    undoStack: [...state.undoStack, {
                        habits: state.habits,
                        habitOrder: state.habitOrder
                    }],
                    redoStack: state.redoStack.slice(1)
                };
            }
            
            // ===== STUDY SESSION ACTIONS =====
            case ActionTypes.START_STUDY_SESSION: {
                const { subject, type = 'regular' } = payload;
                return {
                    ...state,
                    activeStudySession: {
                        subject,
                        startTime: Date.now(),
                        type,
                        pomodoroCount: 0,
                        breakStartTime: null
                    }
                };
            }
            
            case ActionTypes.END_STUDY_SESSION: {
                if (!state.activeStudySession) return state;
                
                const session = {
                    id: crypto.randomUUID(),
                    subject: state.activeStudySession.subject,
                    startTime: state.activeStudySession.startTime,
                    endTime: Date.now(),
                    duration: Math.floor((Date.now() - state.activeStudySession.startTime) / 1000 / 60), // minutes
                    notes: payload?.notes || '',
                    date: DateUtils.toKey(),
                    type: state.activeStudySession.type,
                    pomodoroCount: state.activeStudySession.pomodoroCount || 0
                };
                
                const xpEarned = Math.floor(session.duration / 5) * 2; // 2 XP per 5 minutes
                
                return {
                    ...state,
                    studySessions: [...state.studySessions, session],
                    activeStudySession: null,
                    xp: state.xp + xpEarned
                };
            }
            
            case ActionTypes.DELETE_STUDY_SESSION: {
                return {
                    ...state,
                    studySessions: state.studySessions.filter(s => s.id !== payload.id)
                };
            }
            
            case ActionTypes.UPDATE_STUDY_GOAL: {
                return {
                    ...state,
                    studyGoal: { ...state.studyGoal, ...payload }
                };
            }
            
            // ===== ASSIGNMENT ACTIONS =====
            case ActionTypes.ADD_ASSIGNMENT: {
                const assignment = {
                    id: crypto.randomUUID(),
                    ...payload,
                    createdAt: new Date().toISOString()
                };
                return {
                    ...state,
                    assignments: [...state.assignments, assignment],
                    xp: state.xp + 5 // XP for planning
                };
            }
            
            case ActionTypes.UPDATE_ASSIGNMENT: {
                const { id, updates } = payload;
                const updatedAssignments = state.assignments.map(a =>
                    a.id === id ? { ...a, ...updates } : a
                );
                
                // Award XP for completing assignment
                const assignment = state.assignments.find(a => a.id === id);
                let xpGain = 0;
                if (assignment && updates.status === 'completed' && assignment.status !== 'completed') {
                    xpGain = assignment.type === 'exam' ? 50 : 30;
                }
                
                return {
                    ...state,
                    assignments: updatedAssignments,
                    xp: state.xp + xpGain
                };
            }
            
            case ActionTypes.DELETE_ASSIGNMENT: {
                return {
                    ...state,
                    assignments: state.assignments.filter(a => a.id !== payload.id)
                };
            }
            
            // ===== EXPENSE ACTIONS =====
            case ActionTypes.ADD_EXPENSE: {
                const expense = {
                    id: crypto.randomUUID(),
                    ...payload,
                    date: payload.date || DateUtils.toKey()
                };
                return {
                    ...state,
                    expenses: [...state.expenses, expense],
                    xp: state.xp + 2 // XP for tracking
                };
            }
            
            case ActionTypes.UPDATE_EXPENSE: {
                const { id, updates } = payload;
                return {
                    ...state,
                    expenses: state.expenses.map(e => e.id === id ? { ...e, ...updates } : e)
                };
            }
            
            case ActionTypes.DELETE_EXPENSE: {
                return {
                    ...state,
                    expenses: state.expenses.filter(e => e.id !== payload.id)
                };
            }
            
            case ActionTypes.SET_MONTHLY_BUDGET: {
                return {
                    ...state,
                    monthlyBudget: payload.budget,
                    settings: { ...state.settings, monthlyBudget: payload.budget }
                };
            }
            
            // ===== WELLNESS ACTIONS =====
            case ActionTypes.LOG_SLEEP: {
                const sleepEntry = {
                    id: crypto.randomUUID(),
                    date: payload.date || DateUtils.toKey(),
                    bedtime: payload.bedtime,
                    wakeTime: payload.wakeTime,
                    hours: payload.hours,
                    quality: payload.quality
                };
                return {
                    ...state,
                    sleepLog: [...state.sleepLog, sleepEntry],
                    xp: state.xp + 5
                };
            }
            
            case ActionTypes.DELETE_SLEEP_LOG: {
                return {
                    ...state,
                    sleepLog: state.sleepLog.filter(s => s.id !== payload.id)
                };
            }
            
            case ActionTypes.LOG_WATER: {
                const { date = DateUtils.toKey(), glasses } = payload;
                return {
                    ...state,
                    waterLog: { ...state.waterLog, [date]: glasses },
                    xp: state.xp + 1
                };
            }
            
            case ActionTypes.LOG_EXERCISE: {
                const exercise = {
                    id: crypto.randomUUID(),
                    date: payload.date || DateUtils.toKey(),
                    type: payload.type,
                    duration: payload.duration,
                    notes: payload.notes || ''
                };
                return {
                    ...state,
                    exerciseLog: [...state.exerciseLog, exercise],
                    xp: state.xp + 10
                };
            }
            
            case ActionTypes.DELETE_EXERCISE: {
                return {
                    ...state,
                    exerciseLog: state.exerciseLog.filter(e => e.id !== payload.id)
                };
            }
            
            case ActionTypes.LOG_MOOD: {
                const { date = DateUtils.toKey(), mood, energy, note } = payload;
                return {
                    ...state,
                    moodLog: { ...state.moodLog, [date]: { mood, energy, note } },
                    xp: state.xp + 3
                };
            }
            
            // ===== GOAL ACTIONS =====
            case ActionTypes.ADD_GOAL: {
                const goal = {
                    id: crypto.randomUUID(),
                    ...payload,
                    milestones: payload.milestones || [],
                    createdAt: new Date().toISOString()
                };
                return {
                    ...state,
                    goals: [...state.goals, goal],
                    xp: state.xp + 15
                };
            }
            
            case ActionTypes.UPDATE_GOAL: {
                const { id, updates } = payload;
                return {
                    ...state,
                    goals: state.goals.map(g => g.id === id ? { ...g, ...updates } : g)
                };
            }
            
            case ActionTypes.DELETE_GOAL: {
                return {
                    ...state,
                    goals: state.goals.filter(g => g.id !== payload.id)
                };
            }
            
            case ActionTypes.TOGGLE_MILESTONE: {
                const { goalId, milestoneIndex } = payload;
                const updatedGoals = state.goals.map(goal => {
                    if (goal.id === goalId) {
                        const newMilestones = [...goal.milestones];
                        newMilestones[milestoneIndex] = {
                            ...newMilestones[milestoneIndex],
                            done: !newMilestones[milestoneIndex].done
                        };
                        return { ...goal, milestones: newMilestones };
                    }
                    return goal;
                });
                return {
                    ...state,
                    goals: updatedGoals,
                    xp: state.xp + 5
                };
            }
            
            // ===== TIMETABLE ACTIONS =====
            case ActionTypes.ADD_TIMETABLE_ENTRY: {
                const entry = {
                    id: crypto.randomUUID(),
                    ...payload
                };
                return {
                    ...state,
                    timetable: [...state.timetable, entry]
                };
            }
            
            case ActionTypes.UPDATE_TIMETABLE_ENTRY: {
                const { id, updates } = payload;
                return {
                    ...state,
                    timetable: state.timetable.map(t => t.id === id ? { ...t, ...updates } : t)
                };
            }
            
            case ActionTypes.DELETE_TIMETABLE_ENTRY: {
                return {
                    ...state,
                    timetable: state.timetable.filter(t => t.id !== payload.id)
                };
            }
            
            // ===== JOURNAL ACTIONS =====
            case ActionTypes.ADD_JOURNAL_ENTRY: {
                const entry = {
                    id: crypto.randomUUID(),
                    date: payload.date || DateUtils.toKey(),
                    content: payload.content,
                    mood: payload.mood,
                    energy: payload.energy,
                    gratitude: payload.gratitude || '',
                    tags: payload.tags || [],
                    wordCount: payload.content.trim().split(/\s+/).length
                };
                return {
                    ...state,
                    journalEntries: [...state.journalEntries, entry],
                    xp: state.xp + 10
                };
            }
            
            case ActionTypes.UPDATE_JOURNAL_ENTRY: {
                const { id, updates } = payload;
                return {
                    ...state,
                    journalEntries: state.journalEntries.map(e =>
                        e.id === id ? { ...e, ...updates } : e
                    )
                };
            }
            
            case ActionTypes.DELETE_JOURNAL_ENTRY: {
                return {
                    ...state,
                    journalEntries: state.journalEntries.filter(e => e.id !== payload.id)
                };
            }
            
            // ===== GAMIFICATION ACTIONS =====
            case ActionTypes.ADD_XP: {
                const newXP = state.xp + payload.amount;
                const newLevel = Math.floor(Math.sqrt(newXP / 100)) + 1; // Level formula
                return {
                    ...state,
                    xp: newXP,
                    level: Math.min(newLevel, 50) // Cap at level 50
                };
            }
            
            case ActionTypes.EARN_ACHIEVEMENT: {
                if (state.achievements.includes(payload.id)) return state;
                return {
                    ...state,
                    achievements: [...state.achievements, payload.id],
                    xp: state.xp + (payload.xpReward || 50)
                };
            }
            
            case ActionTypes.GENERATE_DAILY_CHALLENGES: {
                // Clear old challenges if new day
                const today = DateUtils.toKey();
                const existingChallenges = state.dailyChallenges.filter(c => c.date === today);
                
                if (existingChallenges.length > 0) return state;
                
                // Generate 3 daily challenges
                const challenges = [
                    {
                        id: crypto.randomUUID(),
                        text: 'Study for 2 hours today',
                        type: 'study',
                        target: 120,
                        progress: 0,
                        completed: false,
                        date: today,
                        xpReward: 30
                    },
                    {
                        id: crypto.randomUUID(),
                        text: 'Drink 8 glasses of water',
                        type: 'water',
                        target: 8,
                        progress: 0,
                        completed: false,
                        date: today,
                        xpReward: 20
                    },
                    {
                        id: crypto.randomUUID(),
                        text: 'Complete 3 habits',
                        type: 'habits',
                        target: 3,
                        progress: 0,
                        completed: false,
                        date: today,
                        xpReward: 25
                    }
                ];
                
                return {
                    ...state,
                    dailyChallenges: challenges
                };
            }
            
            case ActionTypes.COMPLETE_CHALLENGE: {
                const { id } = payload;
                const challenge = state.dailyChallenges.find(c => c.id === id);
                if (!challenge || challenge.completed) return state;
                
                const updatedChallenges = state.dailyChallenges.map(c =>
                    c.id === id ? { ...c, completed: true } : c
                );
                
                return {
                    ...state,
                    dailyChallenges: updatedChallenges,
                    xp: state.xp + challenge.xpReward
                };
            }
            
            case ActionTypes.LOAD_STATE: {
                return {
                    ...state,
                    ...payload,
                    isLoading: false
                };
            }
            
            case ActionTypes.RESET_STATE: {
                return createInitialState();
            }
            
            default:
                return state;
        }
    }

    // ============================================================================
    // SECTION 5: CUSTOM HOOKS
    // ============================================================================

    /**
     * Debounced localStorage persistence
     */
    function usePersistedState(state, isLoading) {
        const timeoutRef = useRef(null);
        
        useEffect(() => {
            if (isLoading) return;
            
            // Debounce writes
            if (timeoutRef.current) {
                clearTimeout(timeoutRef.current);
            }
            
            timeoutRef.current = setTimeout(() => {
                try {
                    const toSave = {
                        // Existing fields
                        habits: state.habits,
                        habitOrder: state.habitOrder,
                        settings: state.settings,
                        streakFreezes: state.streakFreezes,
                        totalPoints: state.totalPoints,
                        
                        // New fields for StudentOS
                        studySessions: state.studySessions,
                        studyGoal: state.studyGoal,
                        subjects: state.subjects,
                        assignments: state.assignments,
                        expenses: state.expenses,
                        monthlyBudget: state.monthlyBudget,
                        expenseCategories: state.expenseCategories,
                        sleepLog: state.sleepLog,
                        waterLog: state.waterLog,
                        exerciseLog: state.exerciseLog,
                        moodLog: state.moodLog,
                        waterGoal: state.waterGoal,
                        sleepGoal: state.sleepGoal,
                        goals: state.goals,
                        goalCategories: state.goalCategories,
                        timetable: state.timetable,
                        journalEntries: state.journalEntries,
                        xp: state.xp,
                        level: state.level,
                        achievements: state.achievements,
                        dailyChallenges: state.dailyChallenges,
                        appVersion: state.appVersion
                    };
                    localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(toSave));
                } catch (e) {
                    console.error('Failed to persist state:', e);
                }
            }, CONFIG.DEBOUNCE_MS);
            
            return () => {
                if (timeoutRef.current) {
                    clearTimeout(timeoutRef.current);
                }
            };
        }, [state, isLoading]);
    }

    /**
     * Load state from localStorage on mount
     */
    function useLoadState(dispatch) {
        useEffect(() => {
            try {
                const saved = localStorage.getItem(CONFIG.STORAGE_KEY);
                if (saved) {
                    const parsed = JSON.parse(saved);
                    dispatch({ type: ActionTypes.LOAD_STATE, payload: parsed });
                } else {
                    dispatch({ type: ActionTypes.SET_LOADING, payload: false });
                }
            } catch (e) {
                console.error('Failed to load state:', e);
                dispatch({ type: ActionTypes.SET_LOADING, payload: false });
            }
        }, [dispatch]);
    }

    /**
     * Keyboard shortcuts
     */
    function useKeyboardShortcuts(dispatch, state) {
        useEffect(() => {
            const handleKeyDown = (e) => {
                // Ctrl/Cmd + Z = Undo
                if ((e.metaKey || e.ctrlKey) && e.key === 'z' && !e.shiftKey) {
                    e.preventDefault();
                    dispatch({ type: ActionTypes.UNDO });
                    showToast('Undone');
                }
                
                // Ctrl/Cmd + Shift + Z = Redo
                if ((e.metaKey || e.ctrlKey) && e.key === 'z' && e.shiftKey) {
                    e.preventDefault();
                    dispatch({ type: ActionTypes.REDO });
                    showToast('Redone');
                }
                
                // Escape = Exit focus mode
                if (e.key === 'Escape' && state.focusMode.active) {
                    dispatch({ type: ActionTypes.END_FOCUS });
                }
                
                // 1-4 = Switch views
                if (!e.metaKey && !e.ctrlKey && !e.altKey) {
                    const viewMap = { '1': 'dashboard', '2': 'matrix', '3': 'analytics', '4': 'settings' };
                    if (viewMap[e.key]) {
                        dispatch({ type: ActionTypes.SET_VIEW, payload: viewMap[e.key] });
                    }
                }
            };
            
            window.addEventListener('keydown', handleKeyDown);
            return () => window.removeEventListener('keydown', handleKeyDown);
        }, [dispatch, state.focusMode.active]);
    }

    /**
     * Online/offline detection
     */
    function useOnlineStatus() {
        const [isOnline, setIsOnline] = useState(navigator.onLine);
        
        useEffect(() => {
            const handleOnline = () => setIsOnline(true);
            const handleOffline = () => setIsOnline(false);
            
            window.addEventListener('online', handleOnline);
            window.addEventListener('offline', handleOffline);
            
            return () => {
                window.removeEventListener('online', handleOnline);
                window.removeEventListener('offline', handleOffline);
            };
        }, []);
        
        return isOnline;
    }

    // ============================================================================
    // SECTION 6: UI UTILITIES
    // ============================================================================

    /**
     * Show a toast notification
     * @param {string} message - Message to show
     * @param {string} [type='info'] - Type: info, success, error
     */
    function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        if (!container) return;
        
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        toast.setAttribute('role', 'alert');
        
        container.appendChild(toast);
        
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateY(10px)';
            setTimeout(() => toast.remove(), 300);
        }, CONFIG.TOAST_DURATION_MS);
    }

    /**
     * Trigger haptic feedback if supported and enabled
     * @param {string} [type='light'] - Type: light, medium, heavy
     */
    function haptic(type = 'light') {
        if (!navigator.vibrate) return;
        
        const patterns = {
            light: [10],
            medium: [20],
            heavy: [30, 10, 30]
        };
        
        navigator.vibrate(patterns[type] || patterns.light);
    }

    // ============================================================================
    // SECTION 7: CONTEXT
    // ============================================================================

    const AppContext = createContext(null);

    /**
     * Custom hook to access app context
     * @returns {{ state: Object, dispatch: Function }}
     */
    function useApp() {
        const context = useContext(AppContext);
        if (!context) {
            throw new Error('useApp must be used within AppProvider');
        }
        return context;
    }

    // ============================================================================
    // SECTION 8: COMPONENTS
    // ============================================================================

    // --- ATOMS (Basic building blocks) ---

    /**
     * Accessible icon button
     */
    const IconButton = memo(({ 
        icon, 
        label, 
        onClick, 
        className = '', 
        disabled = false,
        size = 'md'
    }) => {
        const sizeClasses = {
            sm: 'w-8 h-8',
            md: 'w-10 h-10',
            lg: 'w-12 h-12'
        };
        
        return (
            <button
                onClick={onClick}
                disabled={disabled}
                aria-label={label}
                title={label}
                className={`touch-target rounded-lg flex items-center justify-center transition-all
                    ${sizeClasses[size]}
                    ${disabled ? 'opacity-50 cursor-not-allowed' : 'hover:bg-slate-700/50 active:scale-95'}
                    ${className}`}
            >
                <span className="text-xl" role="img" aria-hidden="true">{icon}</span>
            </button>
        );
    });

    /**
     * Progress ring component
     */
    const ProgressRing = memo(({ progress, size = 120, strokeWidth = 8, color = '#6366f1', children }) => {
        const radius = (size - strokeWidth) / 2;
        const circumference = 2 * Math.PI * radius;
        const offset = circumference - (progress / 100) * circumference;
        
        return (
            <div className="relative" style={{ width: size, height: size }}>
                <svg width={size} height={size} className="transform -rotate-90">
                    <circle
                        cx={size / 2}
                        cy={size / 2}
                        r={radius}
                        fill="none"
                        stroke="#1e293b"
                        strokeWidth={strokeWidth}
                    />
                    <circle
                        cx={size / 2}
                        cy={size / 2}
                        r={radius}
                        fill="none"
                        stroke={color}
                        strokeWidth={strokeWidth}
                        strokeLinecap="round"
                        strokeDasharray={circumference}
                        strokeDashoffset={offset}
                        className="progress-ring-circle"
                    />
                </svg>
                <div className="absolute inset-0 flex items-center justify-center">
                    {children}
                </div>
            </div>
        );
    });

    /**
     * Badge component
     */
    const Badge = memo(({ children, variant = 'default', className = '' }) => {
        const variants = {
            default: 'bg-slate-700 text-slate-200',
            success: 'bg-emerald-500/20 text-emerald-400',
            warning: 'bg-amber-500/20 text-amber-400',
            danger: 'bg-rose-500/20 text-rose-400',
            info: 'bg-sky-500/20 text-sky-400'
        };
        
        return (
            <span className={`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${variants[variant]} ${className}`}>
                {children}
            </span>
        );
    });

    /**
     * Empty state component
     */
    const EmptyState = memo(({ icon, title, description, action }) => (
        <div className="flex flex-col items-center justify-center py-12 px-4 text-center">
            <div className="w-16 h-16 bg-slate-800 rounded-full flex items-center justify-center mb-4">
                <span className="text-3xl">{icon}</span>
            </div>
            <h3 className="text-lg font-semibold text-white mb-2">{title}</h3>
            <p className="text-slate-400 text-sm mb-6 max-w-xs">{description}</p>
            {action}
        </div>
    ));

    /**
     * Loading skeleton
     */
    const Skeleton = memo(({ className = '' }) => (
        <div className={`skeleton rounded-lg ${className}`} />
    ));

    // --- MOLECULES (Combinations of atoms) ---

    /**
     * Insight card component
     */
    const InsightCard = memo(({ insight }) => {
        const typeStyles = {
            success: 'border-emerald-500/30 bg-emerald-500/5',
            warning: 'border-amber-500/30 bg-amber-500/5',
            urgent: 'border-rose-500/30 bg-rose-500/5 animate-pulse',
            info: 'border-sky-500/30 bg-sky-500/5',
            correlation: 'border-purple-500/30 bg-purple-500/5',
            celebration: 'border-amber-500/30 bg-amber-500/5'
        };
        
        return (
            <div 
                className={`p-4 rounded-xl border ${typeStyles[insight.type] || typeStyles.info}`}
                role="article"
                aria-label={insight.title}
            >
                <div className="flex items-start gap-3">
                    <span className="text-2xl flex-shrink-0" role="img" aria-hidden="true">
                        {insight.icon}
                    </span>
                    <div>
                        <h4 className="font-semibold text-white text-sm">{insight.title}</h4>
                        <p className="text-slate-400 text-sm mt-1">{insight.message}</p>
                    </div>
                </div>
            </div>
        );
    });

    /**
     * Stat card component
     */
    const StatCard = memo(({ icon, label, value, subvalue, color = 'indigo' }) => (
        <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
            <div className="flex items-center justify-between mb-2">
                <span className="text-slate-400 text-sm">{label}</span>
                <span className="text-lg">{icon}</span>
            </div>
            <div className="text-2xl font-bold text-white">{value}</div>
            {subvalue && <div className="text-xs text-slate-500 mt-1">{subvalue}</div>}
        </div>
    ));

        /**
     * Habit item component with full accessibility
     */
    const HabitItem = memo(({ habit, onToggle, onEdit, onStartFocus }) => {
        const todayKey = DateUtils.toKey();
        const isCompleted = !!habit.data?.[todayKey];
        const streak = HabitUtils.calculateStreak(habit.data);
        const completionRate = HabitUtils.calculateCompletionRate(habit.data, 7);
        const colorConfig = CONFIG.COLORS[habit.color] || CONFIG.COLORS.indigo;
        
        const handleToggle = useCallback(() => {
            haptic('medium');
            onToggle(habit.id);
        }, [habit.id, onToggle]);
        
        const handleKeyDown = useCallback((e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                handleToggle();
            }
        }, [handleToggle]);
        
        return (
            <div 
                className={`habit-card group relative bg-slate-800/80 rounded-xl p-4 border-2 transition-all duration-200 ${
                    isCompleted 
                        ? 'border-emerald-500/50 bg-emerald-500/5' 
                        : 'border-slate-700 hover:border-slate-600'
                }`}
                role="listitem"
                aria-label={`${habit.name}, ${isCompleted ? 'completed' : 'not completed'}, ${streak} day streak`}
            >
                <div className="flex items-center gap-4">
                    {/* Completion Toggle Button */}
                    <button
                        onClick={handleToggle}
                        onKeyDown={handleKeyDown}
                        className={`touch-target w-12 h-12 rounded-xl flex items-center justify-center transition-all duration-200 focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-offset-slate-900 ${
                            isCompleted 
                                ? 'text-white shadow-lg scale-100' 
                                : 'bg-slate-700 text-slate-500 hover:bg-slate-600 scale-95 hover:scale-100'
                        }`}
                        style={isCompleted ? { 
                            background: `linear-gradient(135deg, ${colorConfig.bg}, ${colorConfig.dark})`,
                            boxShadow: `0 4px 15px ${colorConfig.bg}40`
                        } : {}}
                        aria-pressed={isCompleted}
                        aria-label={`Mark ${habit.name} as ${isCompleted ? 'incomplete' : 'complete'}`}
                    >
                        {isCompleted ? (
                            <span className="text-xl">âœ“</span>
                        ) : (
                            <div className="w-6 h-6 rounded-md border-2 border-slate-500" />
                        )}
                    </button>
                    
                    {/* Habit Info */}
                    <div className="flex-1 min-w-0">
                        <div className="flex items-center gap-2 flex-wrap">
                            <h3 className={`font-semibold text-white truncate ${isCompleted ? 'line-through opacity-60' : ''}`}>
                                {habit.name}
                            </h3>
                            {habit.quadrant === 'q1' && (
                                <Badge variant="danger">Urgent</Badge>
                            )}
                        </div>
                        
                        <div className="flex items-center gap-3 mt-1.5 flex-wrap">
                            {/* Streak */}
                            {streak > 0 && (
                                <span className={`flex items-center gap-1 text-xs font-medium ${
                                    streak >= 7 ? 'text-amber-400' : 'text-slate-400'
                                }`}>
                                    <span className={streak >= 7 ? 'animate-pulse' : ''}>ðŸ”¥</span>
                                    {streak} day{streak !== 1 ? 's' : ''}
                                </span>
                            )}
                            
                            {/* Category */}
                            <span className="text-xs text-slate-500 bg-slate-700/50 px-2 py-0.5 rounded">
                                {habit.category}
                            </span>
                            
                            {/* Weekly rate */}
                            <span className={`text-xs font-medium ${
                                completionRate >= 80 ? 'text-emerald-400' : 
                                completionRate >= 50 ? 'text-amber-400' : 'text-slate-400'
                            }`}>
                                {completionRate}% this week
                            </span>
                        </div>
                    </div>
                    
                    {/* Actions */}
                    <div className="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                        <IconButton 
                            icon="â±ï¸" 
                            label={`Start focus session for ${habit.name}`}
                            onClick={() => onStartFocus(habit.id)}
                            size="sm"
                        />
                        <IconButton 
                            icon="âœï¸" 
                            label={`Edit ${habit.name}`}
                            onClick={() => onEdit(habit.id)}
                            size="sm"
                        />
                    </div>
                </div>
                
                {/* Mini heatmap (last 7 days) */}
                <div className="flex gap-1 mt-3 pt-3 border-t border-slate-700/50">
                    {Array.from({ length: 7 }, (_, i) => {
                        const date = DateUtils.daysAgo(6 - i);
                        const key = DateUtils.toKey(date);
                        const completed = habit.data?.[key];
                        const dayName = date.toLocaleDateString('en-US', { weekday: 'narrow' });
                        
                        return (
                            <div key={i} className="flex flex-col items-center gap-1 flex-1">
                                <span className="text-[10px] text-slate-500">{dayName}</span>
                                <div 
                                    className={`w-full aspect-square max-w-[24px] rounded-sm transition-colors ${
                                        completed 
                                            ? '' 
                                            : 'bg-slate-700/50'
                                    }`}
                                    style={completed ? { backgroundColor: colorConfig.bg } : {}}
                                    title={`${DateUtils.format(date)}: ${completed ? 'Completed' : 'Missed'}`}
                                />
                            </div>
                        );
                    })}
                </div>
            </div>
        );
    });

    /**
     * Focus Timer Modal
     */
    const FocusTimer = memo(({ habitId, onClose, onComplete }) => {
        const { state, dispatch } = useApp();
        const habit = state.habits[habitId];
        const [elapsed, setElapsed] = useState(0);
        const [isRunning, setIsRunning] = useState(false);
        const [duration, setDuration] = useState(25 * 60); // 25 minutes
        const intervalRef = useRef(null);
        
        useEffect(() => {
            if (isRunning) {
                intervalRef.current = setInterval(() => {
                    setElapsed(prev => {
                        if (prev >= duration) {
                            clearInterval(intervalRef.current);
                            setIsRunning(false);
                            onComplete?.(habitId);
                            showToast('Focus session complete! ðŸŽ‰', 'success');
                            haptic('heavy');
                            return duration;
                        }
                        return prev + 1;
                    });
                }, 1000);
            }
            
            return () => {
                if (intervalRef.current) {
                    clearInterval(intervalRef.current);
                }
            };
        }, [isRunning, duration, habitId, onComplete]);
        
        const progress = (elapsed / duration) * 100;
        const remaining = duration - elapsed;
        const minutes = Math.floor(remaining / 60);
        const seconds = remaining % 60;
        
        const colorConfig = CONFIG.COLORS[habit?.color] || CONFIG.COLORS.indigo;
        
        const handleStart = () => {
            setIsRunning(true);
            dispatch({ type: ActionTypes.START_FOCUS, payload: { habitId, duration } });
        };
        
        const handlePause = () => {
            setIsRunning(false);
        };
        
        const handleReset = () => {
            setIsRunning(false);
            setElapsed(0);
        };
        
        const handleClose = () => {
            if (isRunning) {
                if (!confirm('End focus session early?')) return;
            }
            dispatch({ type: ActionTypes.END_FOCUS });
            onClose();
        };
        
        return (
            <div 
                className="fixed inset-0 z-50 flex items-center justify-center bg-slate-950/95 backdrop-blur-sm animate-fade-in"
                role="dialog"
                aria-modal="true"
                aria-labelledby="focus-timer-title"
            >
                <div className="w-full max-w-md p-6 text-center">
                    {/* Close button */}
                    <button
                        onClick={handleClose}
                        className="absolute top-4 right-4 p-2 text-slate-400 hover:text-white transition-colors"
                        aria-label="Close focus timer"
                    >
                        <span className="text-2xl">Ã—</span>
                    </button>
                    
                    {/* Habit name */}
                    <h2 
                        id="focus-timer-title"
                        className="text-xl font-bold text-white mb-2"
                    >
                        {habit?.name || 'Focus Session'}
                    </h2>
                    <p className="text-slate-400 text-sm mb-8">Deep work mode - minimize distractions</p>
                    
                    {/* Timer Ring */}
                    <div className="flex justify-center mb-8">
                        <ProgressRing 
                            progress={progress} 
                            size={200} 
                            strokeWidth={12}
                            color={colorConfig.bg}
                        >
                            <div className="text-center">
                                <div className="text-4xl font-bold text-white font-mono">
                                    {String(minutes).padStart(2, '0')}:{String(seconds).padStart(2, '0')}
                                </div>
                                <div className="text-xs text-slate-400 mt-1">
                                    {isRunning ? 'FOCUSING' : elapsed > 0 ? 'PAUSED' : 'READY'}
                                </div>
                            </div>
                        </ProgressRing>
                    </div>
                    
                    {/* Duration selector (only when not started) */}
                    {elapsed === 0 && !isRunning && (
                        <div className="flex justify-center gap-2 mb-6">
                            {[15, 25, 45, 60].map(mins => (
                                <button
                                    key={mins}
                                    onClick={() => setDuration(mins * 60)}
                                    className={`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${
                                        duration === mins * 60
                                            ? 'bg-indigo-600 text-white'
                                            : 'bg-slate-800 text-slate-400 hover:bg-slate-700'
                                    }`}
                                >
                                    {mins}m
                                </button>
                            ))}
                        </div>
                    )}
                    
                    {/* Control buttons */}
                    <div className="flex justify-center gap-3">
                        {!isRunning ? (
                            <button
                                onClick={handleStart}
                                className="px-8 py-3 bg-indigo-600 hover:bg-indigo-500 rounded-xl text-white font-bold text-lg transition-colors"
                            >
                                {elapsed > 0 ? 'Resume' : 'Start Focus'}
                            </button>
                        ) : (
                            <button
                                onClick={handlePause}
                                className="px-8 py-3 bg-amber-600 hover:bg-amber-500 rounded-xl text-white font-bold text-lg transition-colors"
                            >
                                Pause
                            </button>
                        )}
                        
                        {elapsed > 0 && (
                            <button
                                onClick={handleReset}
                                className="px-6 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl text-white font-medium transition-colors"
                            >
                                Reset
                            </button>
                        )}
                    </div>
                    
                    {/* Tips */}
                    <div className="mt-8 p-4 bg-slate-800/50 rounded-xl text-left">
                        <h4 className="text-sm font-semibold text-slate-300 mb-2">ðŸ’¡ Focus Tips</h4>
                        <ul className="text-xs text-slate-400 space-y-1">
                            <li>â€¢ Put your phone on Do Not Disturb</li>
                            <li>â€¢ Close unnecessary browser tabs</li>
                            <li>â€¢ Take a short break after the session</li>
                        </ul>
                    </div>
                </div>
            </div>
        );
    });

    /**
     * Add/Edit Habit Modal
     */
    const HabitModal = memo(({ habitId = null, onClose }) => {
        const { state, dispatch } = useApp();
        const existingHabit = habitId ? state.habits[habitId] : null;
        
        const [name, setName] = useState(existingHabit?.name || '');
        const [color, setColor] = useState(existingHabit?.color || 'indigo');
        const [category, setCategory] = useState(existingHabit?.category || 'General');
        const [quadrant, setQuadrant] = useState(existingHabit?.quadrant || 'q2');
        const [errors, setErrors] = useState({});
        
        const inputRef = useRef(null);
        const modalId = useId();
        
        useEffect(() => {
            inputRef.current?.focus();
        }, []);
        
        const validate = () => {
            const newErrors = {};
            if (!name.trim()) {
                newErrors.name = 'Habit name is required';
            } else if (name.trim().length < 2) {
                newErrors.name = 'Name must be at least 2 characters';
            } else if (name.trim().length > 50) {
                newErrors.name = 'Name must be less than 50 characters';
            }
            setErrors(newErrors);
            return Object.keys(newErrors).length === 0;
        };
        
        const handleSubmit = (e) => {
            e.preventDefault();
            
            if (!validate()) return;
            
            if (existingHabit) {
                dispatch({
                    type: ActionTypes.UPDATE_HABIT,
                    payload: {
                        id: habitId,
                        updates: { name: name.trim(), color, category, quadrant }
                    }
                });
                showToast('Habit updated', 'success');
            } else {
                dispatch({
                    type: ActionTypes.ADD_HABIT,
                    payload: { name: name.trim(), color, category, quadrant }
                });
                showToast('Habit created', 'success');
            }
            
            onClose();
        };
        
        const handleDelete = () => {
            if (confirm(`Delete "${existingHabit.name}"? This cannot be undone.`)) {
                dispatch({ type: ActionTypes.DELETE_HABIT, payload: { id: habitId } });
                showToast('Habit deleted', 'info');
                onClose();
            }
        };
        
        const handleBackdropClick = (e) => {
            if (e.target === e.currentTarget) {
                onClose();
            }
        };
        
        return (
            <div 
                className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/60 backdrop-blur-sm animate-fade-in"
                onClick={handleBackdropClick}
                role="dialog"
                aria-modal="true"
                aria-labelledby={`${modalId}-title`}
            >
                <div 
                    className="w-full sm:max-w-md bg-slate-900 rounded-t-3xl sm:rounded-2xl p-6 animate-slide-up border border-slate-700"
                    role="document"
                >
                    {/* Handle for mobile */}
                    <div className="w-12 h-1 bg-slate-700 rounded-full mx-auto mb-6 sm:hidden" />
                    
                    <h2 id={`${modalId}-title`} className="text-xl font-bold text-white mb-6">
                        {existingHabit ? 'Edit Habit' : 'New Habit'}
                    </h2>
                    
                    <form onSubmit={handleSubmit} className="space-y-5">
                        {/* Name Input */}
                        <div>
                            <label htmlFor={`${modalId}-name`} className="block text-sm font-medium text-slate-300 mb-2">
                                Habit Name *
                            </label>
                            <input
                                ref={inputRef}
                                id={`${modalId}-name`}
                                type="text"
                                value={name}
                                onChange={(e) => setName(e.target.value)}
                                placeholder="e.g., Read for 30 minutes"
                                className={`w-full px-4 py-3 bg-slate-800 border rounded-xl text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 ${
                                    errors.name ? 'border-rose-500' : 'border-slate-700'
                                }`}
                                aria-invalid={errors.name ? 'true' : 'false'}
                                aria-describedby={errors.name ? `${modalId}-name-error` : undefined}
                            />
                            {errors.name && (
                                <p id={`${modalId}-name-error`} className="mt-1 text-sm text-rose-400">
                                    {errors.name}
                                </p>
                            )}
                        </div>
                        
                        {/* Category & Quadrant */}
                        <div className="grid grid-cols-2 gap-3">
                            <div>
                                <label htmlFor={`${modalId}-category`} className="block text-sm font-medium text-slate-300 mb-2">
                                    Category
                                </label>
                                <select
                                    id={`${modalId}-category`}
                                    value={category}
                                    onChange={(e) => setCategory(e.target.value)}
                                    className="w-full px-3 py-2.5 bg-slate-800 border border-slate-700 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                >
                                    <option value="General">General</option>
                                    {CONFIG.CATEGORIES.map(cat => (
                                        <option key={cat} value={cat}>{cat}</option>
                                    ))}
                                </select>
                            </div>
                            
                            <div>
                                <label htmlFor={`${modalId}-quadrant`} className="block text-sm font-medium text-slate-300 mb-2">
                                    Priority
                                </label>
                                <select
                                    id={`${modalId}-quadrant`}
                                    value={quadrant}
                                    onChange={(e) => setQuadrant(e.target.value)}
                                    className="w-full px-3 py-2.5 bg-slate-800 border border-slate-700 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                >
                                    {Object.entries(CONFIG.QUADRANTS).map(([key, q]) => (
                                        <option key={key} value={key}>{q.name}</option>
                                    ))}
                                </select>
                            </div>
                        </div>
                        
                        {/* Color Picker */}
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-2">
                                Color
                            </label>
                            <div className="flex flex-wrap gap-2" role="radiogroup" aria-label="Select habit color">
                                {Object.entries(CONFIG.COLORS).map(([colorName, colorConfig]) => (
                                    <button
                                        key={colorName}
                                        type="button"
                                        onClick={() => setColor(colorName)}
                                        className={`w-10 h-10 rounded-full transition-all touch-target ${
                                            color === colorName 
                                                ? 'ring-2 ring-white ring-offset-2 ring-offset-slate-900 scale-110' 
                                                : 'opacity-60 hover:opacity-100'
                                        }`}
                                        style={{ backgroundColor: colorConfig.bg }}
                                        role="radio"
                                        aria-checked={color === colorName}
                                        aria-label={colorName}
                                    />
                                ))}
                            </div>
                        </div>
                        
                        {/* Action Buttons */}
                        <div className="flex gap-3 pt-4">
                            {existingHabit && (
                                <button
                                    type="button"
                                    onClick={handleDelete}
                                    className="px-4 py-3 bg-rose-500/10 hover:bg-rose-500/20 text-rose-400 rounded-xl font-medium transition-colors"
                                >
                                    Delete
                                </button>
                            )}
                            <button
                                type="button"
                                onClick={onClose}
                                className="flex-1 py-3 bg-slate-800 hover:bg-slate-700 rounded-xl text-slate-300 font-medium transition-colors"
                            >
                                Cancel
                            </button>
                            <button
                                type="submit"
                                className="flex-1 py-3 bg-indigo-600 hover:bg-indigo-500 rounded-xl text-white font-medium transition-colors"
                            >
                                {existingHabit ? 'Save' : 'Create'}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        );
    });

    // --- ORGANISMS (Complex UI sections) ---

    /**
     * Insights Panel with real AI-generated insights
     */
    const InsightsPanel = memo(() => {
        const { state } = useApp();
        
        const insights = useMemo(() => 
            AnalyticsEngine.generateInsights(state.habits, state.habitOrder),
            [state.habits, state.habitOrder]
        );
        
        if (insights.length === 0) return null;
        
        return (
            <section 
                className="mb-6"
                aria-labelledby="insights-heading"
            >
                <div className="flex items-center gap-2 mb-4">
                    <span className="text-2xl">ðŸ§ </span>
                    <h2 id="insights-heading" className="font-bold text-white">
                        AI Insights
                    </h2>
                    <Badge variant="info">Real data</Badge>
                </div>
                
                <div className="space-y-3">
                    {insights.map((insight) => (
                        <InsightCard key={insight.id} insight={insight} />
                    ))}
                </div>
            </section>
        );
    });

    /**
     * Stats Overview
     */
    const StatsOverview = memo(() => {
        const { state } = useApp();
        
        const stats = useMemo(() => {
            const activeHabits = state.habitOrder
                .map(id => state.habits[id])
                .filter(h => h && !h.archived);
            
            if (activeHabits.length === 0) {
                return { todayCompleted: 0, todayTotal: 0, weeklyRate: 0, totalStreak: 0, longestStreak: 0 };
            }
            
            const todayKey = DateUtils.toKey();
            const todayCompleted = activeHabits.filter(h => h.data?.[todayKey]).length;
            const todayTotal = activeHabits.length;
            
            // Weekly rate
            let weekTotal = 0;
            let weekCompleted = 0;
            activeHabits.forEach(habit => {
                for (let i = 0; i < 7; i++) {
                    const key = DateUtils.toKey(DateUtils.daysAgo(i));
                    weekTotal++;
                    if (habit.data?.[key]) weekCompleted++;
                }
            });
            const weeklyRate = Math.round((weekCompleted / weekTotal) * 100);
            
            // Best current streak
            let bestStreak = 0;
            let bestLongestStreak = 0;
            activeHabits.forEach(habit => {
                const current = HabitUtils.calculateStreak(habit.data);
                const longest = HabitUtils.calculateLongestStreak(habit.data);
                if (current > bestStreak) bestStreak = current;
                if (longest > bestLongestStreak) bestLongestStreak = longest;
            });
            
            return {
                todayCompleted,
                todayTotal,
                weeklyRate,
                totalStreak: bestStreak,
                longestStreak: bestLongestStreak
            };
        }, [state.habits, state.habitOrder]);
        
        const todayProgress = stats.todayTotal > 0 
            ? Math.round((stats.todayCompleted / stats.todayTotal) * 100) 
            : 0;
        
        return (
            <section 
                className="mb-6"
                aria-labelledby="stats-heading"
            >
                {/* Hero Progress Card */}
                <div className="bg-gradient-to-br from-indigo-600 to-purple-700 rounded-2xl p-6 mb-4 relative overflow-hidden">
                    <div className="absolute top-0 right-0 w-40 h-40 bg-white/10 rounded-full -mr-20 -mt-20" />
                    <div className="absolute bottom-0 left-0 w-24 h-24 bg-white/5 rounded-full -ml-12 -mb-12" />
                    
                    <div className="relative z-10">
                        <h2 id="stats-heading" className="text-indigo-200 text-sm font-medium mb-1">
                            Today's Progress
                        </h2>
                        
                        <div className="flex items-end justify-between">
                            <div>
                                <span className="text-5xl font-bold text-white">{stats.todayCompleted}</span>
                                <span className="text-2xl text-indigo-200">/{stats.todayTotal}</span>
                            </div>
                            
                            <div className="text-right">
                                <div className="text-3xl font-bold text-white">{todayProgress}%</div>
                                <p className="text-xs text-indigo-200">
                                    {todayProgress === 100 
                                        ? 'ðŸŽ‰ Perfect day!' 
                                        : todayProgress >= 50 
                                            ? 'Keep going!' 
                                            : "Let's start!"}
                                </p>
                            </div>
                        </div>
                        
                        {/* Progress bar */}
                        <div className="mt-4 w-full bg-white/20 h-3 rounded-full overflow-hidden">
                            <div 
                                className="h-full bg-white rounded-full transition-all duration-500"
                                style={{ width: `${todayProgress}%` }}
                                role="progressbar"
                                aria-valuenow={todayProgress}
                                aria-valuemin={0}
                                aria-valuemax={100}
                            />
                        </div>
                    </div>
                </div>
                
                {/* Stats Grid */}
                <div className="grid grid-cols-2 sm:grid-cols-4 gap-3">
                    <StatCard 
                        icon="ðŸ“Š" 
                        label="Weekly Rate" 
                        value={`${stats.weeklyRate}%`}
                        subvalue="Last 7 days"
                    />
                    <StatCard 
                        icon="ðŸ”¥" 
                        label="Best Streak" 
                        value={stats.totalStreak}
                        subvalue="Current"
                    />
                    <StatCard 
                        icon="ðŸ†" 
                        label="Record" 
                        value={stats.longestStreak}
                        subvalue="All time"
                    />
                    <StatCard 
                        icon="â„ï¸" 
                        label="Freezes" 
                        value={state.streakFreezes}
                        subvalue="Available"
                    />
                </div>
            </section>
        );
    });

    /**
     * Habits List
     */
    const HabitsList = memo(({ onEdit, onStartFocus }) => {
        const { state, dispatch } = useApp();
        
        const activeHabits = useMemo(() => 
            state.habitOrder
                .map(id => state.habits[id])
                .filter(h => h && !h.archived),
            [state.habits, state.habitOrder]
        );
        
        const handleToggle = useCallback((id) => {
            dispatch({ type: ActionTypes.TOGGLE_HABIT, payload: { id } });
        }, [dispatch]);
        
        if (activeHabits.length === 0) {
            return (
                <EmptyState
                    icon="ðŸŽ¯"
                    title="No habits yet"
                    description="Create your first habit to start building better routines."
                />
            );
        }
        
        return (
            <section aria-labelledby="habits-heading">
                <h2 id="habits-heading" className="sr-only">Your Habits</h2>
                <div 
                    className="space-y-3"
                    role="list"
                    aria-label="Habits list"
                >
                    {activeHabits.map(habit => (
                        <HabitItem
                            key={habit.id}
                            habit={habit}
                            onToggle={handleToggle}
                            onEdit={onEdit}
                            onStartFocus={onStartFocus}
                        />
                    ))}
                </div>
            </section>
        );
    });

    // --- STUDENT OS SPECIFIC COMPONENTS ---

    /**
     * Study Timer Component
     */
    const StudyTimer = memo(({ onClose }) => {
        const { state, dispatch } = useApp();
        const [selectedSubject, setSelectedSubject] = useState('');
        const [timerMode, setTimerMode] = useState('regular'); // regular or pomodoro
        const [timeElapsed, setTimeElapsed] = useState(0);
        const [isRunning, setIsRunning] = useState(false);
        
        useEffect(() => {
            let interval;
            if (isRunning) {
                interval = setInterval(() => {
                    setTimeElapsed(prev => prev + 1);
                }, 1000);
            }
            return () => clearInterval(interval);
        }, [isRunning]);
        
        const handleStart = () => {
            if (!state.activeStudySession) {
                dispatch({
                    type: ActionTypes.START_STUDY_SESSION,
                    payload: { subject: selectedSubject, type: timerMode }
                });
            }
            setIsRunning(true);
        };
        
        const handleStop = () => {
            setIsRunning(false);
            if (state.activeStudySession) {
                dispatch({ type: ActionTypes.END_STUDY_SESSION });
                showToast(`Study session saved! +${Math.floor(timeElapsed / 60 / 5) * 2} XP`, 'success');
            }
            setTimeElapsed(0);
            onClose();
        };
        
        const formatTime = (seconds) => {
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        };
        
        return (
            <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm">
                <div className="w-full max-w-md mx-4 bg-slate-900 rounded-2xl p-6 border border-slate-700">
                    <h3 className="text-xl font-bold text-white mb-4">Study Timer</h3>
                    
                    {!isRunning && (
                        <>
                            <div className="mb-4">
                                <label className="block text-sm font-medium text-slate-300 mb-2">Subject</label>
                                <input
                                    type="text"
                                    value={selectedSubject}
                                    onChange={(e) => setSelectedSubject(e.target.value)}
                                    placeholder="e.g., Mathematics, Physics, etc."
                                    className="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white"
                                />
                            </div>
                            
                            <div className="mb-6">
                                <label className="block text-sm font-medium text-slate-300 mb-2">Mode</label>
                                <div className="flex gap-2">
                                    <button
                                        onClick={() => setTimerMode('regular')}
                                        className={`flex-1 py-2 rounded-lg font-medium transition-colors ${
                                            timerMode === 'regular' ? 'bg-indigo-500 text-white' : 'bg-slate-800 text-slate-400'
                                        }`}
                                    >
                                        Regular
                                    </button>
                                    <button
                                        onClick={() => setTimerMode('pomodoro')}
                                        className={`flex-1 py-2 rounded-lg font-medium transition-colors ${
                                            timerMode === 'pomodoro' ? 'bg-indigo-500 text-white' : 'bg-slate-800 text-slate-400'
                                        }`}
                                    >
                                        Pomodoro
                                    </button>
                                </div>
                            </div>
                        </>
                    )}
                    
                    <div className="text-center mb-6">
                        <div className="text-6xl font-mono font-bold text-indigo-400 mb-2">
                            {formatTime(timeElapsed)}
                        </div>
                        <div className="text-slate-400">{selectedSubject}</div>
                    </div>
                    
                    <div className="flex gap-3">
                        {!isRunning ? (
                            <>
                                <button
                                    onClick={onClose}
                                    className="flex-1 py-3 bg-slate-800 hover:bg-slate-700 rounded-xl text-white font-medium transition-colors"
                                >
                                    Cancel
                                </button>
                                <button
                                    onClick={handleStart}
                                    className="flex-1 py-3 bg-indigo-500 hover:bg-indigo-600 rounded-xl text-white font-medium transition-colors"
                                >
                                    Start
                                </button>
                            </>
                        ) : (
                            <>
                                <button
                                    onClick={() => setIsRunning(false)}
                                    className="flex-1 py-3 bg-amber-500 hover:bg-amber-600 rounded-xl text-white font-medium transition-colors"
                                >
                                    Pause
                                </button>
                                <button
                                    onClick={handleStop}
                                    className="flex-1 py-3 bg-rose-500 hover:bg-rose-600 rounded-xl text-white font-medium transition-colors"
                                >
                                    Stop & Save
                                </button>
                            </>
                        )}
                    </div>
                </div>
            </div>
        );
    });

    /**
     * Assignment Form Modal
     */
    const AssignmentModal = memo(({ onClose, assignment = null }) => {
        const { dispatch } = useApp();
        const [title, setTitle] = useState(assignment?.title || '');
        const [subject, setSubject] = useState(assignment?.subject || 'Math');
        const [dueDate, setDueDate] = useState(assignment?.dueDate || '');
        const [type, setType] = useState(assignment?.type || 'assignment');
        const [priority, setPriority] = useState(assignment?.priority || 'medium');
        
        const handleSubmit = (e) => {
            e.preventDefault();
            if (!title.trim() || !dueDate) return;
            
            if (assignment) {
                dispatch({
                    type: ActionTypes.UPDATE_ASSIGNMENT,
                    payload: {
                        id: assignment.id,
                        updates: { title: title.trim(), subject, dueDate, type, priority }
                    }
                });
                showToast('Assignment updated', 'success');
            } else {
                dispatch({
                    type: ActionTypes.ADD_ASSIGNMENT,
                    payload: {
                        title: title.trim(),
                        subject,
                        dueDate,
                        type,
                        priority,
                        status: 'pending',
                        prepProgress: 0
                    }
                });
                showToast('Assignment added! +5 XP', 'success');
            }
            onClose();
        };
        
        return (
            <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/60 backdrop-blur-sm">
                <div className="w-full sm:max-w-md bg-slate-900 rounded-t-3xl sm:rounded-2xl p-6 border border-slate-700">
                    <h3 className="text-xl font-bold text-white mb-4">
                        {assignment ? 'Edit Assignment' : 'New Assignment'}
                    </h3>
                    
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-2">Title *</label>
                            <input
                                type="text"
                                value={title}
                                onChange={(e) => setTitle(e.target.value)}
                                placeholder="e.g., Math homework chapter 5"
                                className="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white"
                                required
                            />
                        </div>
                        
                        <div className="grid grid-cols-2 gap-3">
                            <div>
                                <label className="block text-sm font-medium text-slate-300 mb-2">Subject</label>
                                <input
                                    type="text"
                                    value={subject}
                                    onChange={(e) => setSubject(e.target.value)}
                                    className="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-300 mb-2">Type</label>
                                <select
                                    value={type}
                                    onChange={(e) => setType(e.target.value)}
                                    className="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white"
                                >
                                    <option value="assignment">Assignment</option>
                                    <option value="exam">Exam</option>
                                </select>
                            </div>
                        </div>
                        
                        <div className="grid grid-cols-2 gap-3">
                            <div>
                                <label className="block text-sm font-medium text-slate-300 mb-2">Due Date *</label>
                                <input
                                    type="date"
                                    value={dueDate}
                                    onChange={(e) => setDueDate(e.target.value)}
                                    className="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white"
                                    required
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-300 mb-2">Priority</label>
                                <select
                                    value={priority}
                                    onChange={(e) => setPriority(e.target.value)}
                                    className="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white"
                                >
                                    <option value="low">Low</option>
                                    <option value="medium">Medium</option>
                                    <option value="high">High</option>
                                </select>
                            </div>
                        </div>
                        
                        <div className="flex gap-3 pt-4">
                            <button
                                type="button"
                                onClick={onClose}
                                className="flex-1 py-3 bg-slate-800 hover:bg-slate-700 rounded-xl text-white font-medium transition-colors"
                            >
                                Cancel
                            </button>
                            <button
                                type="submit"
                                className="flex-1 py-3 bg-indigo-500 hover:bg-indigo-600 rounded-xl text-white font-medium transition-colors"
                            >
                                {assignment ? 'Update' : 'Add'}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        );
    });

    /**
     * Timetable Modal - Add/Edit Class Schedule
     */
    const TimetableModal = memo(({ onClose, entry = null }) => {
        const { dispatch } = useApp();
        const [subject, setSubject] = useState(entry?.subject || '');
        const [day, setDay] = useState(entry?.day || 'Monday');
        const [startTime, setStartTime] = useState(entry?.startTime || '');
        const [endTime, setEndTime] = useState(entry?.endTime || '');
        const [room, setRoom] = useState(entry?.room || '');
        const [notes, setNotes] = useState(entry?.notes || '');
        
        const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
        const colors = ['bg-indigo-500', 'bg-purple-500', 'bg-pink-500', 'bg-rose-500', 'bg-orange-500', 'bg-amber-500', 'bg-emerald-500', 'bg-cyan-500'];
        
        const handleSubmit = (e) => {
            e.preventDefault();
            if (!subject.trim() || !startTime || !endTime) return;
            
            if (entry) {
                dispatch({
                    type: ActionTypes.UPDATE_TIMETABLE_ENTRY,
                    payload: {
                        id: entry.id,
                        updates: { subject: subject.trim(), day, startTime, endTime, room, notes }
                    }
                });
                showToast('Class updated', 'success');
            } else {
                const color = colors[Math.floor(Math.random() * colors.length)];
                dispatch({
                    type: ActionTypes.ADD_TIMETABLE_ENTRY,
                    payload: {
                        subject: subject.trim(),
                        day,
                        startTime,
                        endTime,
                        room,
                        color,
                        notes
                    }
                });
                showToast('Class added', 'success');
            }
            onClose();
        };
        
        return (
            <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/60 backdrop-blur-sm">
                <div className="w-full sm:max-w-md bg-slate-900 rounded-t-3xl sm:rounded-2xl p-6 border border-slate-700">
                    <h3 className="text-xl font-bold text-white mb-4">
                        {entry ? 'Edit Class' : 'Add Class'}
                    </h3>
                    
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-2">Subject *</label>
                            <input
                                type="text"
                                value={subject}
                                onChange={(e) => setSubject(e.target.value)}
                                placeholder="e.g., Mathematics, Physics, etc."
                                className="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white"
                                required
                            />
                        </div>
                        
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-2">Day of Week *</label>
                            <select
                                value={day}
                                onChange={(e) => setDay(e.target.value)}
                                className="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white"
                            >
                                {days.map(d => (
                                    <option key={d} value={d}>{d}</option>
                                ))}
                            </select>
                        </div>
                        
                        <div className="grid grid-cols-2 gap-3">
                            <div>
                                <label className="block text-sm font-medium text-slate-300 mb-2">Start Time *</label>
                                <input
                                    type="time"
                                    value={startTime}
                                    onChange={(e) => setStartTime(e.target.value)}
                                    className="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white"
                                    required
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-300 mb-2">End Time *</label>
                                <input
                                    type="time"
                                    value={endTime}
                                    onChange={(e) => setEndTime(e.target.value)}
                                    className="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white"
                                    required
                                />
                            </div>
                        </div>
                        
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-2">Room/Location</label>
                            <input
                                type="text"
                                value={room}
                                onChange={(e) => setRoom(e.target.value)}
                                placeholder="e.g., Room 101, Building A"
                                className="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white"
                            />
                        </div>
                        
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-2">Notes</label>
                            <input
                                type="text"
                                value={notes}
                                onChange={(e) => setNotes(e.target.value)}
                                placeholder="e.g., Bring textbook"
                                className="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white"
                            />
                        </div>
                        
                        <div className="flex gap-3 pt-4">
                            <button
                                type="button"
                                onClick={onClose}
                                className="flex-1 py-3 bg-slate-800 hover:bg-slate-700 rounded-xl text-white font-medium transition-colors"
                            >
                                Cancel
                            </button>
                            <button
                                type="submit"
                                className="flex-1 py-3 bg-indigo-500 hover:bg-indigo-600 rounded-xl text-white font-medium transition-colors"
                            >
                                {entry ? 'Update' : 'Add'}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        );
    });

    /**
     * Wellness Tracker Modal - Log sleep, water, exercise, mood
     */
    const WellnessModal = memo(({ type, onClose }) => {
        const { state, dispatch } = useApp();
        const today = DateUtils.toKey();
        const [formData, setFormData] = useState(() => {
            if (type === 'sleep') return { bedtime: '', wakeTime: '', quality: 3 };
            if (type === 'water') return { glasses: state.waterLog[today] || 0 };
            if (type === 'exercise') return { type: 'walk', duration: 30, notes: '' };
            if (type === 'mood') return { mood: 'neutral', energy: 3, note: '' };
            return {};
        });
        
        const handleSubmit = (e) => {
            e.preventDefault();
            
            if (type === 'sleep') {
                const bedtime = new Date(`2000-01-01 ${formData.bedtime}`);
                const wakeTime = new Date(`2000-01-01 ${formData.wakeTime}`);
                let hours = (wakeTime - bedtime) / (1000 * 60 * 60);
                if (hours < 0) hours += 24; // Handle overnight sleep
                
                dispatch({
                    type: ActionTypes.LOG_SLEEP,
                    payload: {
                        bedtime: formData.bedtime,
                        wakeTime: formData.wakeTime,
                        hours: Math.round(hours * 10) / 10,
                        quality: formData.quality
                    }
                });
                showToast('Sleep logged! +5 XP', 'success');
            } else if (type === 'water') {
                dispatch({
                    type: ActionTypes.LOG_WATER,
                    payload: { glasses: formData.glasses }
                });
                showToast('Water intake updated! +1 XP', 'success');
            } else if (type === 'exercise') {
                dispatch({
                    type: ActionTypes.LOG_EXERCISE,
                    payload: {
                        type: formData.type,
                        duration: formData.duration,
                        notes: formData.notes
                    }
                });
                showToast('Exercise logged! +10 XP', 'success');
            } else if (type === 'mood') {
                dispatch({
                    type: ActionTypes.LOG_MOOD,
                    payload: {
                        mood: formData.mood,
                        energy: formData.energy,
                        note: formData.note
                    }
                });
                showToast('Mood logged! +3 XP', 'success');
            }
            
            onClose();
        };
        
        const titles = {
            sleep: 'ðŸ’¤ Log Sleep',
            water: 'ðŸ’§ Log Water',
            exercise: 'ðŸƒ Log Exercise',
            mood: 'ðŸ˜Š Log Mood'
        };
        
        return (
            <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/60 backdrop-blur-sm">
                <div className="w-full sm:max-w-md bg-slate-900 rounded-t-3xl sm:rounded-2xl p-6 border border-slate-700">
                    <h3 className="text-xl font-bold text-white mb-4">{titles[type]}</h3>
                    
                    <form onSubmit={handleSubmit} className="space-y-4">
                        {type === 'sleep' && (
                            <>
                                <div>
                                    <label className="block text-sm font-medium text-slate-300 mb-2">Bedtime</label>
                                    <input
                                        type="time"
                                        value={formData.bedtime}
                                        onChange={(e) => setFormData({ ...formData, bedtime: e.target.value })}
                                        className="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white"
                                        required
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-300 mb-2">Wake Time</label>
                                    <input
                                        type="time"
                                        value={formData.wakeTime}
                                        onChange={(e) => setFormData({ ...formData, wakeTime: e.target.value })}
                                        className="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white"
                                        required
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-300 mb-2">Quality (1-5 stars)</label>
                                    <div className="flex gap-2">
                                        {[1, 2, 3, 4, 5].map(star => (
                                            <button
                                                key={star}
                                                type="button"
                                                onClick={() => setFormData({ ...formData, quality: star })}
                                                className="text-2xl transition-transform hover:scale-110"
                                            >
                                                {star <= formData.quality ? 'â­' : 'â˜†'}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </>
                        )}
                        
                        {type === 'water' && (
                            <div>
                                <label className="block text-sm font-medium text-slate-300 mb-2">Glasses of Water</label>
                                <input
                                    type="number"
                                    min="0"
                                    max="20"
                                    value={formData.glasses}
                                    onChange={(e) => setFormData({ ...formData, glasses: parseInt(e.target.value) || 0 })}
                                    className="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white"
                                />
                                <div className="mt-2 text-xs text-slate-400">Goal: 8 glasses/day</div>
                            </div>
                        )}
                        
                        {type === 'exercise' && (
                            <>
                                <div>
                                    <label className="block text-sm font-medium text-slate-300 mb-2">Type</label>
                                    <select
                                        value={formData.type}
                                        onChange={(e) => setFormData({ ...formData, type: e.target.value })}
                                        className="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white"
                                    >
                                        <option value="walk">Walk</option>
                                        <option value="run">Run</option>
                                        <option value="gym">Gym</option>
                                        <option value="yoga">Yoga</option>
                                        <option value="sport">Sport</option>
                                        <option value="other">Other</option>
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-300 mb-2">Duration (minutes)</label>
                                    <input
                                        type="number"
                                        min="1"
                                        value={formData.duration}
                                        onChange={(e) => setFormData({ ...formData, duration: parseInt(e.target.value) || 0 })}
                                        className="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-300 mb-2">Notes (optional)</label>
                                    <textarea
                                        value={formData.notes}
                                        onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                                        className="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white resize-none"
                                        rows="2"
                                    />
                                </div>
                            </>
                        )}
                        
                        {type === 'mood' && (
                            <>
                                <div>
                                    <label className="block text-sm font-medium text-slate-300 mb-2">How are you feeling?</label>
                                    <div className="flex justify-around gap-2">
                                        {Object.entries(CONFIG.MOODS).map(([key, emoji]) => (
                                            <button
                                                key={key}
                                                type="button"
                                                onClick={() => setFormData({ ...formData, mood: key })}
                                                className={`text-4xl transition-all ${
                                                    formData.mood === key ? 'scale-125' : 'opacity-50 hover:opacity-100'
                                                }`}
                                            >
                                                {emoji}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-300 mb-2">Energy Level (1-5)</label>
                                    <input
                                        type="range"
                                        min="1"
                                        max="5"
                                        value={formData.energy}
                                        onChange={(e) => setFormData({ ...formData, energy: parseInt(e.target.value) })}
                                        className="w-full"
                                    />
                                    <div className="flex justify-between text-xs text-slate-400 mt-1">
                                        <span>Low</span>
                                        <span className="text-white font-medium">{formData.energy}</span>
                                        <span>High</span>
                                    </div>
                                </div>
                                <div>
                                    <label className="block text-sm font-medium text-slate-300 mb-2">Note (optional)</label>
                                    <textarea
                                        value={formData.note}
                                        onChange={(e) => setFormData({ ...formData, note: e.target.value })}
                                        className="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white resize-none"
                                        rows="2"
                                        placeholder="How was your day?"
                                    />
                                </div>
                            </>
                        )}
                        
                        <div className="flex gap-3 pt-4">
                            <button
                                type="button"
                                onClick={onClose}
                                className="flex-1 py-3 bg-slate-800 hover:bg-slate-700 rounded-xl text-white font-medium transition-colors"
                            >
                                Cancel
                            </button>
                            <button
                                type="submit"
                                className="flex-1 py-3 bg-indigo-500 hover:bg-indigo-600 rounded-xl text-white font-medium transition-colors"
                            >
                                Save
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        );
    });

    /**
     * Journal Entry Modal
     */
    const JournalEntryModal = memo(({ entry, onClose }) => {
        const { dispatch } = useApp();
        const today = DateUtils.toKey();
        const [content, setContent] = useState(entry?.content || '');
        const [mood, setMood] = useState(entry?.mood || 'neutral');
        const [energy, setEnergy] = useState(entry?.energy || 3);
        const [gratitude, setGratitude] = useState(entry?.gratitude || '');
        
        const handleSubmit = (e) => {
            e.preventDefault();
            if (!content.trim()) return;
            
            if (entry) {
                dispatch({
                    type: ActionTypes.UPDATE_JOURNAL_ENTRY,
                    payload: {
                        id: entry.id,
                        updates: { content: content.trim(), mood, energy, gratitude: gratitude.trim() }
                    }
                });
                showToast('Journal updated', 'success');
            } else {
                dispatch({
                    type: ActionTypes.ADD_JOURNAL_ENTRY,
                    payload: {
                        content: content.trim(),
                        mood,
                        energy,
                        gratitude: gratitude.trim()
                    }
                });
                showToast('Journal entry saved! +10 XP', 'success');
            }
            onClose();
        };
        
        return (
            <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/60 backdrop-blur-sm">
                <div className="w-full sm:max-w-lg bg-slate-900 rounded-t-3xl sm:rounded-2xl p-6 border border-slate-700 max-h-[90vh] overflow-y-auto">
                    <h3 className="text-xl font-bold text-white mb-4">
                        {entry ? 'Edit Entry' : 'âœï¸ New Journal Entry'}
                    </h3>
                    
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-2">How was your day?</label>
                            <textarea
                                value={content}
                                onChange={(e) => setContent(e.target.value)}
                                placeholder="Write about your day, thoughts, and feelings..."
                                className="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white resize-none"
                                rows="6"
                                required
                            />
                            <div className="mt-1 text-xs text-slate-400">
                                {content.trim().split(/\s+/).filter(w => w).length} words
                            </div>
                        </div>
                        
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-2">Mood</label>
                            <div className="flex justify-around gap-2">
                                {Object.entries(CONFIG.MOODS).map(([key, emoji]) => (
                                    <button
                                        key={key}
                                        type="button"
                                        onClick={() => setMood(key)}
                                        className={`text-3xl transition-all ${
                                            mood === key ? 'scale-125' : 'opacity-50 hover:opacity-100'
                                        }`}
                                    >
                                        {emoji}
                                    </button>
                                ))}
                            </div>
                        </div>
                        
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-2">Energy Level</label>
                            <input
                                type="range"
                                min="1"
                                max="5"
                                value={energy}
                                onChange={(e) => setEnergy(parseInt(e.target.value))}
                                className="w-full"
                            />
                            <div className="flex justify-between text-xs text-slate-400 mt-1">
                                <span>Low</span>
                                <span className="text-white font-medium">{energy}</span>
                                <span>High</span>
                            </div>
                        </div>
                        
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-2">Gratitude (optional)</label>
                            <input
                                type="text"
                                value={gratitude}
                                onChange={(e) => setGratitude(e.target.value)}
                                placeholder="What are you grateful for today?"
                                className="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white"
                            />
                        </div>
                        
                        <div className="flex gap-3 pt-4">
                            <button
                                type="button"
                                onClick={onClose}
                                className="flex-1 py-3 bg-slate-800 hover:bg-slate-700 rounded-xl text-white font-medium transition-colors"
                            >
                                Cancel
                            </button>
                            <button
                                type="submit"
                                className="flex-1 py-3 bg-indigo-500 hover:bg-indigo-600 rounded-xl text-white font-medium transition-colors"
                            >
                                {entry ? 'Update' : 'Save Entry'}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        );
    });

    // --- TEMPLATES (Full page layouts) ---

    /**
     * Eisenhower Matrix View
     */
    const MatrixView = memo(() => {
        const { state, dispatch } = useApp();
        
        const quadrantHabits = useMemo(() => {
            const result = { q1: [], q2: [], q3: [], q4: [] };
            
            state.habitOrder.forEach(id => {
                const habit = state.habits[id];
                if (!habit || habit.archived) return;
                const q = habit.quadrant || 'q2';
                result[q].push(habit);
            });
            
            return result;
        }, [state.habits, state.habitOrder]);
        
        const handleDrop = useCallback((habitId, newQuadrant) => {
            dispatch({
                type: ActionTypes.UPDATE_HABIT,
                payload: { id: habitId, updates: { quadrant: newQuadrant } }
            });
            showToast('Habit moved', 'success');
        }, [dispatch]);
        
        const QuadrantBox = ({ quadrantKey, quadrant, habits }) => {
            const [isDragOver, setIsDragOver] = useState(false);
            
            const colorClasses = {
                q1: 'border-rose-500/30 bg-rose-500/5',
                q2: 'border-purple-500/30 bg-purple-500/5',
                q3: 'border-amber-500/30 bg-amber-500/5',
                q4: 'border-slate-500/30 bg-slate-500/5'
            };
            
            const headerColors = {
                q1: 'text-rose-400',
                q2: 'text-purple-400',
                q3: 'text-amber-400',
                q4: 'text-slate-400'
            };
            
            return (
                <div
                    className={`rounded-xl p-4 border-2 transition-all min-h-[200px] ${
                        isDragOver 
                            ? 'border-indigo-500 bg-indigo-500/10' 
                            : colorClasses[quadrantKey]
                    }`}
                    onDragOver={(e) => {
                        e.preventDefault();
                        setIsDragOver(true);
                    }}
                    onDragLeave={() => setIsDragOver(false)}
                    onDrop={(e) => {
                        e.preventDefault();
                        setIsDragOver(false);
                        const habitId = e.dataTransfer.getData('habitId');
                        if (habitId) handleDrop(habitId, quadrantKey);
                    }}
                >
                    <div className="flex items-center justify-between mb-3">
                        <div>
                            <h3 className={`font-bold text-sm ${headerColors[quadrantKey]}`}>
                                {quadrant.name}
                            </h3>
                            <p className="text-xs text-slate-500">{quadrant.description}</p>
                        </div>
                        <Badge>{habits.length}</Badge>
                    </div>
                    
                    <div className="space-y-2">
                        {habits.map(habit => (
                            <div
                                key={habit.id}
                                draggable
                                onDragStart={(e) => e.dataTransfer.setData('habitId', habit.id)}
                                className="p-3 bg-slate-800/80 rounded-lg border border-slate-700 cursor-move hover:border-indigo-500/50 transition-colors"
                            >
                                <div className="flex items-center gap-2">
                                    <div 
                                        className="w-2 h-2 rounded-full"
                                        style={{ backgroundColor: CONFIG.COLORS[habit.color]?.bg }}
                                    />
                                    <span className="text-sm text-white truncate">{habit.name}</span>
                                </div>
                            </div>
                        ))}
                        
                        {habits.length === 0 && (
                            <p className="text-xs text-slate-500 text-center py-4">
                                Drag habits here
                            </p>
                        )}
                    </div>
                </div>
            );
        };
        
        return (
            <div className="p-4">
                <h2 className="text-xl font-bold text-white mb-4">Eisenhower Matrix</h2>
                <p className="text-sm text-slate-400 mb-6">
                    Drag habits between quadrants to prioritize them.
                </p>
                
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    {Object.entries(CONFIG.QUADRANTS).map(([key, quadrant]) => (
                        <QuadrantBox
                            key={key}
                            quadrantKey={key}
                            quadrant={quadrant}
                            habits={quadrantHabits[key]}
                        />
                    ))}
                </div>
            </div>
        );
    });

    /**
     * Analytics View with real statistics
     */
    const AnalyticsView = memo(() => {
        const { state } = useApp();
        const canvasRef = useRef(null);
        
        const analyticsData = useMemo(() => {
            const activeHabits = state.habitOrder
                .map(id => state.habits[id])
                .filter(h => h && !h.archived);
            
            // Daily completion rates for last 30 days
            const dailyRates = [];
            for (let i = 29; i >= 0; i--) {
                const date = DateUtils.daysAgo(i);
                const key = DateUtils.toKey(date);
                let completed = 0;
                activeHabits.forEach(h => {
                    if (h.data?.[key]) completed++;
                });
                const rate = activeHabits.length > 0 
                    ? Math.round((completed / activeHabits.length) * 100) 
                    : 0;
                dailyRates.push({ date: key, rate });
            }
            
            // Day of week analysis
            const dayOfWeekData = [0, 0, 0, 0, 0, 0, 0].map(() => ({ completed: 0, total: 0 }));
            activeHabits.forEach(habit => {
                Object.keys(habit.data || {}).forEach(key => {
                    const day = DateUtils.dayOfWeek(key);
                    dayOfWeekData[day].total++;
                    if (habit.data[key]) dayOfWeekData[day].completed++;
                });
            });
            
            const dayOfWeekRates = dayOfWeekData.map(d => 
                d.total > 0 ? Math.round((d.completed / d.total) * 100) : 0
            );
            
            // Trend calculation
            const recentRates = dailyRates.slice(-7).map(d => d.rate);
            const trend = StatsUtils.trend(recentRates);
            
            // Moving average
            const movingAvg = StatsUtils.movingAverage(dailyRates.map(d => d.rate), 7);
            
            return {
                dailyRates,
                dayOfWeekRates,
                trend,
                movingAvg,
                habitCount: activeHabits.length
            };
        }, [state.habits, state.habitOrder]);
        
        // Draw chart
        useEffect(() => {
            const canvas = canvasRef.current;
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            const padding = 40;
            
            // Clear
            ctx.fillStyle = '#0f172a';
            ctx.fillRect(0, 0, width, height);
            
            // Draw grid
            ctx.strokeStyle = '#1e293b';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const y = padding + (i / 4) * (height - 2 * padding);
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();
                
                // Y-axis labels
                ctx.fillStyle = '#64748b';
                ctx.font = '10px Inter, sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(`${100 - i * 25}%`, padding - 8, y + 4);
            }
            
            // Draw data
            const data = analyticsData.dailyRates;
            const pointWidth = (width - 2 * padding) / (data.length - 1);
            
            // Area fill
            ctx.beginPath();
            ctx.moveTo(padding, height - padding);
            data.forEach((d, i) => {
                const x = padding + i * pointWidth;
                const y = padding + ((100 - d.rate) / 100) * (height - 2 * padding);
                ctx.lineTo(x, y);
            });
            ctx.lineTo(padding + (data.length - 1) * pointWidth, height - padding);
            ctx.closePath();
            
            const gradient = ctx.createLinearGradient(0, padding, 0, height - padding);
            gradient.addColorStop(0, 'rgba(99, 102, 241, 0.3)');
            gradient.addColorStop(1, 'rgba(99, 102, 241, 0)');
            ctx.fillStyle = gradient;
            ctx.fill();
            
            // Line
            ctx.beginPath();
            ctx.strokeStyle = '#6366f1';
            ctx.lineWidth = 2;
            data.forEach((d, i) => {
                const x = padding + i * pointWidth;
                const y = padding + ((100 - d.rate) / 100) * (height - 2 * padding);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();
            
            // Moving average line
            ctx.beginPath();
            ctx.strokeStyle = '#f59e0b';
            ctx.lineWidth = 1;
            ctx.setLineDash([4, 4]);
            analyticsData.movingAvg.forEach((rate, i) => {
                const x = padding + i * pointWidth;
                const y = padding + ((100 - rate) / 100) * (height - 2 * padding);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();
            ctx.setLineDash([]);
            
        }, [analyticsData]);
        
        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        
        return (
            <div className="p-4 space-y-6">
                <h2 className="text-xl font-bold text-white">Analytics</h2>
                
                {analyticsData.habitCount === 0 ? (
                    <EmptyState
                        icon="ðŸ“Š"
                        title="No data yet"
                        description="Complete some habits to see your analytics."
                    />
                ) : (
                    <>
                        {/* Trend indicator */}
                        <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                            <div className="flex items-center justify-between">
                                <div>
                                    <h3 className="text-sm text-slate-400">7-Day Trend</h3>
                                    <div className="flex items-center gap-2 mt-1">
                                        <span className="text-2xl">
                                            {analyticsData.trend.direction === 'up' ? 'ðŸ“ˆ' : 
                                             analyticsData.trend.direction === 'down' ? 'ðŸ“‰' : 'âž¡ï¸'}
                                        </span>
                                        <span className={`text-lg font-bold ${
                                            analyticsData.trend.direction === 'up' ? 'text-emerald-400' :
                                            analyticsData.trend.direction === 'down' ? 'text-rose-400' :
                                            'text-slate-400'
                                        }`}>
                                            {analyticsData.trend.direction === 'up' ? 'Improving' :
                                             analyticsData.trend.direction === 'down' ? 'Declining' :
                                             'Stable'}
                                        </span>
                                    </div>
                                </div>
                                <div className="text-right">
                                    <div className="text-xs text-slate-500">Slope</div>
                                    <div className="font-mono text-sm text-slate-300">
                                        {analyticsData.trend.slope.toFixed(3)}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {/* 30-day chart */}
                        <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                            <h3 className="text-sm text-slate-400 mb-4">30-Day Completion Rate</h3>
                            <canvas 
                                ref={canvasRef} 
                                width={600} 
                                height={200}
                                className="w-full h-auto"
                                role="img"
                                aria-label="30-day completion rate chart"
                            />
                            <div className="flex justify-center gap-4 mt-3 text-xs">
                                <div className="flex items-center gap-2">
                                    <div className="w-3 h-3 bg-indigo-500 rounded" />
                                    <span className="text-slate-400">Daily Rate</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <div className="w-3 h-0.5 bg-amber-500" />
                                    <span className="text-slate-400">7-Day Average</span>
                                </div>
                            </div>
                        </div>
                        
                        {/* Day of week performance */}
                        <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                            <h3 className="text-sm text-slate-400 mb-4">Performance by Day</h3>
                            <div className="grid grid-cols-7 gap-2">
                                {analyticsData.dayOfWeekRates.map((rate, i) => (
                                    <div key={i} className="text-center">
                                        <div className="text-xs text-slate-500 mb-2">{dayNames[i]}</div>
                                        <div 
                                            className="mx-auto w-8 rounded-t-sm transition-all"
                                            style={{ 
                                                height: `${Math.max(rate, 5)}px`,
                                                backgroundColor: rate >= 70 ? '#10b981' : rate >= 40 ? '#f59e0b' : '#64748b'
                                            }}
                                        />
                                        <div className="text-xs font-medium text-slate-300 mt-1">{rate}%</div>
                                    </div>
                                ))}
                            </div>
                        </div>
                        
                        {/* Statistical summary */}
                        <div className="grid grid-cols-2 gap-3">
                            <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                                <div className="text-xs text-slate-500">Pearson Consistency</div>
                                <div className="text-xl font-bold text-white mt-1">
                                    {(() => {
                                        const rates = analyticsData.dailyRates.map(d => d.rate);
                                        const indices = rates.map((_, i) => i);
                                        const corr = StatsUtils.pearsonCorrelation(indices, rates);
                                        return corr.toFixed(2);
                                    })()}
                                </div>
                                <div className="text-xs text-slate-500 mt-1">-1 to 1 scale</div>
                            </div>
                            <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                                <div className="text-xs text-slate-500">Std Deviation</div>
                                <div className="text-xl font-bold text-white mt-1">
                                    {StatsUtils.stdDev(analyticsData.dailyRates.map(d => d.rate)).toFixed(1)}%
                                </div>
                                <div className="text-xs text-slate-500 mt-1">Consistency measure</div>
                            </div>
                        </div>
                    </>
                )}
            </div>
        );
    });

    /**
     * Settings View
     */
    const SettingsView = memo(() => {
        const { state, dispatch } = useApp();
        const fileInputRef = useRef(null);
        
        const handleExport = () => {
            const data = {
                version: CONFIG.VERSION,
                exportedAt: new Date().toISOString(),
                habits: state.habits,
                habitOrder: state.habitOrder,
                settings: state.settings,
                streakFreezes: state.streakFreezes,
                totalPoints: state.totalPoints
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `habitos-backup-${DateUtils.toKey()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Data exported', 'success');
        };
        
        const handleImport = (e) => {
            const file = e.target.files?.[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = JSON.parse(event.target.result);
                    
                    if (!data.habits || !data.habitOrder) {
                        throw new Error('Invalid backup format');
                    }
                    
                    if (confirm(`Import ${Object.keys(data.habits).length} habits? This will replace your current data.`)) {
                        dispatch({
                            type: ActionTypes.LOAD_STATE,
                            payload: {
                                habits: data.habits,
                                habitOrder: data.habitOrder,
                                settings: data.settings || state.settings,
                                streakFreezes: data.streakFreezes ?? 2,
                                totalPoints: data.totalPoints ?? 0
                            }
                        });
                        showToast('Data imported successfully', 'success');
                    }
                } catch (err) {
                    console.error(err);
                    showToast('Invalid backup file', 'error');
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        };
        
        const handleReset = () => {
            if (confirm('Reset ALL data? This cannot be undone!')) {
                if (confirm('Are you REALLY sure? All habits and history will be deleted.')) {
                    dispatch({ type: ActionTypes.RESET_STATE });
                    localStorage.removeItem(CONFIG.STORAGE_KEY);
                    showToast('All data reset', 'info');
                }
            }
        };
        
        return (
            <div className="p-4 space-y-6">
                <h2 className="text-xl font-bold text-white">Settings</h2>
                
                {/* App Info */}
                <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                    <div className="flex items-center gap-3">
                        <div className="w-12 h-12 bg-indigo-600 rounded-xl flex items-center justify-center text-2xl">
                            ðŸ“š
                        </div>
                        <div>
                            <h3 className="font-bold text-white">{CONFIG.APP_NAME}</h3>
                            <p className="text-xs text-slate-400">Version {CONFIG.VERSION}</p>
                        </div>
                    </div>
                </div>
                
                {/* Quick Access */}
                <div className="space-y-3">
                    <h3 className="text-sm font-semibold text-slate-300">Quick Access</h3>
                    
                    <button
                        onClick={() => dispatch({ type: ActionTypes.SET_VIEW, payload: 'expenses' })}
                        className="w-full flex items-center justify-between p-4 bg-slate-800/50 rounded-xl border border-slate-700 hover:bg-slate-800 transition-colors"
                    >
                        <div className="flex items-center gap-3">
                            <span className="text-xl">ðŸ’°</span>
                            <div className="text-left">
                                <div className="font-medium text-white">Expense Tracker</div>
                                <div className="text-xs text-slate-400">Manage your budget</div>
                            </div>
                        </div>
                        <span className="text-slate-400">â†’</span>
                    </button>
                    
                    <button
                        onClick={() => dispatch({ type: ActionTypes.SET_VIEW, payload: 'matrix' })}
                        className="w-full flex items-center justify-between p-4 bg-slate-800/50 rounded-xl border border-slate-700 hover:bg-slate-800 transition-colors"
                    >
                        <div className="flex items-center gap-3">
                            <span className="text-xl">ðŸ“Š</span>
                            <div className="text-left">
                                <div className="font-medium text-white">Eisenhower Matrix</div>
                                <div className="text-xs text-slate-400">Priority quadrants</div>
                            </div>
                        </div>
                        <span className="text-slate-400">â†’</span>
                    </button>
                </div>
                
                {/* Data Management */}
                <div className="space-y-3">
                    <h3 className="text-sm font-semibold text-slate-300">Data Management</h3>
                    
                    <button
                        onClick={handleExport}
                        className="w-full flex items-center justify-between p-4 bg-slate-800/50 rounded-xl border border-slate-700 hover:bg-slate-800 transition-colors"
                    >
                        <div className="flex items-center gap-3">
                            <span className="text-xl">ðŸ’¾</span>
                            <div className="text-left">
                                <div className="font-medium text-white">Export Data</div>
                                <div className="text-xs text-slate-400">Download backup file</div>
                            </div>
                        </div>
                        <span className="text-slate-400">â†’</span>
                    </button>
                    
                    <button
                        onClick={() => fileInputRef.current?.click()}
                        className="w-full flex items-center justify-between p-4 bg-slate-800/50 rounded-xl border border-slate-700 hover:bg-slate-800 transition-colors"
                    >
                        <div className="flex items-center gap-3">
                            <span className="text-xl">ðŸ“‚</span>
                            <div className="text-left">
                                <div className="font-medium text-white">Import Data</div>
                                <div className="text-xs text-slate-400">Restore from backup</div>
                            </div>
                        </div>
                        <span className="text-slate-400">â†’</span>
                    </button>
                    <input
                        ref={fileInputRef}
                        type="file"
                        accept=".json"
                        onChange={handleImport}
                        className="hidden"
                    />
                    
                    <button
                        onClick={handleReset}
                        className="w-full flex items-center justify-between p-4 bg-rose-500/10 rounded-xl border border-rose-500/30 hover:bg-rose-500/20 transition-colors"
                    >
                        <div className="flex items-center gap-3">
                            <span className="text-xl">ðŸ—‘ï¸</span>
                            <div className="text-left">
                                <div className="font-medium text-rose-400">Reset All Data</div>
                                <div className="text-xs text-rose-400/70">Delete everything</div>
                            </div>
                        </div>
                        <span className="text-rose-400">â†’</span>
                    </button>
                </div>
                
                {/* Statistics */}
                <div className="space-y-3">
                    <h3 className="text-sm font-semibold text-slate-300">Your Stats</h3>
                    <div className="grid grid-cols-2 gap-3">
                        <div className="bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                            <div className="text-2xl font-bold text-white">
                                {Object.keys(state.habits).length}
                            </div>
                            <div className="text-xs text-slate-400">Total Habits</div>
                        </div>
                        <div className="bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                            <div className="text-2xl font-bold text-white">
                                {Object.values(state.habits).reduce((sum, h) => 
                                    sum + Object.keys(h.data || {}).length, 0
                                )}
                            </div>
                            <div className="text-xs text-slate-400">Total Completions</div>
                        </div>
                        <div className="bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                            <div className="text-2xl font-bold text-white">
                                {state.totalPoints}
                            </div>
                            <div className="text-xs text-slate-400">Points Earned</div>
                        </div>
                        <div className="bg-slate-800/50 p-4 rounded-xl border border-slate-700">
                            <div className="text-2xl font-bold text-white">
                                {state.streakFreezes}
                            </div>
                            <div className="text-xs text-slate-400">Streak Freezes</div>
                        </div>
                    </div>
                </div>
                
                {/* Keyboard Shortcuts */}
                <div className="space-y-3">
                    <h3 className="text-sm font-semibold text-slate-300">Keyboard Shortcuts</h3>
                    <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700 space-y-2 text-sm">
                        <div className="flex justify-between">
                            <span className="text-slate-400">Undo</span>
                            <kbd className="px-2 py-0.5 bg-slate-700 rounded text-xs text-slate-300">Ctrl/âŒ˜ + Z</kbd>
                        </div>
                        <div className="flex justify-between">
                            <span className="text-slate-400">Redo</span>
                            <kbd className="px-2 py-0.5 bg-slate-700 rounded text-xs text-slate-300">Ctrl/âŒ˜ + Shift + Z</kbd>
                        </div>
                        <div className="flex justify-between">
                            <span className="text-slate-400">Navigate Views</span>
                            <kbd className="px-2 py-0.5 bg-slate-700 rounded text-xs text-slate-300">1, 2, 3, 4</kbd>
                        </div>
                        <div className="flex justify-between">
                            <span className="text-slate-400">Exit Focus Mode</span>
                            <kbd className="px-2 py-0.5 bg-slate-700 rounded text-xs text-slate-300">Esc</kbd>
                        </div>
                    </div>
                </div>
                
                {/* Credits */}
                <div className="text-center pt-6 text-xs text-slate-500">
                    <p>Built with React, Tailwind CSS, and â¤ï¸</p>
                    <p className="mt-1">Real statistics. No fake AI.</p>
                </div>
            </div>
        );
    });

    // --- TEMPLATES (Full page layouts) ---

    /**
     * Dashboard Page
     */
    const DashboardPage = memo(() => {
        const { state, dispatch } = useApp();
        const [showAddModal, setShowAddModal] = useState(false);
        const [editingHabitId, setEditingHabitId] = useState(null);
        const [focusHabitId, setFocusHabitId] = useState(null);
        
        const today = DateUtils.toKey();
        
        // Calculate widget stats
        const todayStudyTime = useMemo(() => {
            return state.studySessions
                .filter(s => s.date === today)
                .reduce((sum, s) => sum + s.duration, 0);
        }, [state.studySessions, today]);
        
        const nextAssignment = useMemo(() => {
            const pending = state.assignments
                .filter(a => a.status !== 'completed' && new Date(a.dueDate) >= new Date())
                .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
            return pending[0];
        }, [state.assignments]);
        
        const todayWater = state.waterLog[today] || 0;
        const todaySleep = state.sleepLog.find(s => s.date === today);
        
        const handleStartFocus = useCallback((habitId) => {
            setFocusHabitId(habitId);
        }, []);
        
        const handleFocusComplete = useCallback((habitId) => {
            dispatch({ type: ActionTypes.TOGGLE_HABIT, payload: { id: habitId } });
        }, [dispatch]);
        
        // Calculate best habit streak
        const bestStreak = useMemo(() => {
            const habits = Object.values(state.habits).filter(h => !h.archived);
            if (habits.length === 0) return { name: 'None', days: 0 };
            
            const habitStreaks = habits.map(h => ({
                name: h.name,
                days: HabitUtils.calculateStreak(h.data)
            }));
            
            return habitStreaks.reduce((best, current) => 
                current.days > best.days ? current : best
            , { name: 'None', days: 0 });
        }, [state.habits]);
        
        return (
            <>
                <StatsOverview />
                
                {/* Quick Access Widgets */}
                <div className="grid grid-cols-2 gap-3 mb-6">
                    {/* Study Widget */}
                    <button
                        onClick={() => dispatch({ type: ActionTypes.SET_VIEW, payload: 'study' })}
                        className="bg-gradient-to-br from-indigo-500/10 to-purple-500/10 rounded-xl p-4 border border-indigo-500/20 text-left hover:from-indigo-500/20 hover:to-purple-500/20 transition-all"
                    >
                        <div className="text-2xl mb-1">â±ï¸</div>
                        <div className="text-lg font-bold text-white">{Math.floor(todayStudyTime / 60)}h {todayStudyTime % 60}m</div>
                        <div className="text-xs text-slate-400">Study Today</div>
                    </button>
                    
                    {/* Next Assignment Widget */}
                    <button
                        onClick={() => dispatch({ type: ActionTypes.SET_VIEW, payload: 'study' })}
                        className="bg-gradient-to-br from-amber-500/10 to-rose-500/10 rounded-xl p-4 border border-amber-500/20 text-left hover:from-amber-500/20 hover:to-rose-500/20 transition-all"
                    >
                        <div className="text-2xl mb-1">ðŸ“</div>
                        <div className="text-sm font-bold text-white truncate">
                            {nextAssignment ? nextAssignment.title : 'No tasks'}
                        </div>
                        <div className="text-xs text-slate-400">
                            {nextAssignment ? 
                                `Due ${Math.ceil((new Date(nextAssignment.dueDate) - new Date()) / (1000 * 60 * 60 * 24))}d` 
                                : 'All clear!'}
                        </div>
                    </button>
                    
                    {/* Wellness Widget */}
                    <button
                        onClick={() => dispatch({ type: ActionTypes.SET_VIEW, payload: 'journal' })}
                        className="bg-gradient-to-br from-emerald-500/10 to-cyan-500/10 rounded-xl p-4 border border-emerald-500/20 text-left hover:from-emerald-500/20 hover:to-cyan-500/20 transition-all"
                    >
                        <div className="text-2xl mb-1">ðŸ’§</div>
                        <div className="text-lg font-bold text-white">{todayWater}/{state.waterGoal}</div>
                        <div className="text-xs text-slate-400">Water Today</div>
                    </button>
                    
                    {/* XP Widget */}
                    <div className="bg-gradient-to-br from-purple-500/10 to-pink-500/10 rounded-xl p-4 border border-purple-500/20">
                        <div className="text-2xl mb-1">ðŸ†</div>
                        <div className="text-lg font-bold text-white">Level {state.level}</div>
                        <div className="text-xs text-slate-400">{state.xp} XP</div>
                    </div>
                </div>
                
                {/* Insights Panel */}
                <InsightsPanel />
                
                {/* Today's Habits */}
                <div className="flex items-center justify-between mb-4">
                    <h2 className="font-bold text-white text-lg">Today's Habits</h2>
                    <button
                        onClick={() => setShowAddModal(true)}
                        className="text-indigo-400 text-sm font-medium hover:text-indigo-300 transition-colors"
                    >
                        + Add Habit
                    </button>
                </div>
                
                <HabitsList 
                    onEdit={setEditingHabitId}
                    onStartFocus={handleStartFocus}
                />
                
                {/* Best Streak Card */}
                {bestStreak.days > 0 && (
                    <div className="bg-gradient-to-r from-orange-500/10 to-red-500/10 rounded-xl p-4 border border-orange-500/20 mt-6">
                        <div className="flex items-center justify-between">
                            <div>
                                <div className="text-sm text-slate-400 mb-1">ðŸ”¥ Current Best Streak</div>
                                <div className="text-lg font-bold text-white">{bestStreak.name}</div>
                            </div>
                            <div className="text-3xl font-bold text-orange-400">{bestStreak.days}d</div>
                        </div>
                    </div>
                )}
                
                {/* Modals */}
                {showAddModal && (
                    <HabitModal onClose={() => setShowAddModal(false)} />
                )}
                
                {editingHabitId && (
                    <HabitModal 
                        habitId={editingHabitId} 
                        onClose={() => setEditingHabitId(null)} 
                    />
                )}
                
                {focusHabitId && (
                    <FocusTimer
                        habitId={focusHabitId}
                        onClose={() => setFocusHabitId(null)}
                        onComplete={handleFocusComplete}
                    />
                )}
            </>
        );
    });

    /**
     * Study View - Study sessions, assignments, and timetable
     */
    const StudyView = memo(() => {
        const { state, dispatch } = useApp();
        const [activeTab, setActiveTab] = useState('timer'); // timer, assignments, timetable
        const [showStudyTimer, setShowStudyTimer] = useState(false);
        const [showAssignmentModal, setShowAssignmentModal] = useState(false);
        const [editingAssignment, setEditingAssignment] = useState(null);
        const [showTimetableModal, setShowTimetableModal] = useState(false);
        const [editingTimetable, setEditingTimetable] = useState(null);
        
        // Calculate today's study time
        const todayStudyTime = useMemo(() => {
            const today = DateUtils.toKey();
            return state.studySessions
                .filter(s => s.date === today)
                .reduce((sum, s) => sum + s.duration, 0);
        }, [state.studySessions]);
        
        // Get pending assignments
        const pendingAssignments = useMemo(() => {
            return state.assignments
                .filter(a => a.status !== 'completed')
                .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
        }, [state.assignments]);
        
        // Calculate days until due
        const getDaysUntil = (dueDate) => {
            const days = Math.ceil((new Date(dueDate) - new Date()) / (1000 * 60 * 60 * 24));
            return days;
        };
        
        const getUrgencyColor = (daysUntil) => {
            if (daysUntil < 0) return 'text-slate-500';
            if (daysUntil <= 1) return 'text-rose-400';
            if (daysUntil <= 3) return 'text-amber-400';
            return 'text-emerald-400';
        };
        
        return (
            <div className="space-y-6">
                {/* Header */}
                <div>
                    <h2 className="text-2xl font-bold text-white mb-2">ðŸ“š Study Hub</h2>
                    <p className="text-slate-400 text-sm">Track study sessions, manage assignments, and view your timetable</p>
                </div>
                
                {/* Tab Navigation */}
                <div className="flex gap-2 bg-slate-800/50 p-1 rounded-xl">
                    {[
                        { id: 'timer', label: 'Study Timer', icon: 'â±ï¸' },
                        { id: 'assignments', label: 'Assignments', icon: 'ðŸ“' },
                        { id: 'timetable', label: 'Timetable', icon: 'ðŸ“…' }
                    ].map(tab => (
                        <button
                            key={tab.id}
                            onClick={() => setActiveTab(tab.id)}
                            className={`flex-1 py-2 px-4 rounded-lg text-sm font-medium transition-all ${
                                activeTab === tab.id
                                    ? 'bg-indigo-500 text-white'
                                    : 'text-slate-400 hover:text-white'
                            }`}
                        >
                            <span className="mr-2">{tab.icon}</span>
                            {tab.label}
                        </button>
                    ))}
                </div>
                
                {/* Content */}
                {activeTab === 'timer' && (
                    <div className="space-y-4">
                        <div className="bg-slate-800/50 rounded-xl p-6 border border-slate-700">
                            <div className="text-center py-8">
                                <div className="text-4xl mb-4">â±ï¸</div>
                                <h3 className="text-lg font-semibold text-white mb-2">Study Timer</h3>
                                <p className="text-slate-400 mb-4">Track your study sessions with Pomodoro support</p>
                                <button
                                    onClick={() => setShowStudyTimer(true)}
                                    className="px-6 py-3 bg-indigo-500 hover:bg-indigo-600 text-white rounded-xl font-medium transition-colors"
                                >
                                    Start Study Session
                                </button>
                            </div>
                        </div>
                        
                        {/* Recent Sessions */}
                        {state.studySessions.length > 0 && (
                            <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                                <h4 className="text-sm font-semibold text-white mb-3">Recent Sessions</h4>
                                <div className="space-y-2">
                                    {state.studySessions.slice(-5).reverse().map(session => (
                                        <div key={session.id} className="flex items-center justify-between py-2 border-b border-slate-700 last:border-0">
                                            <div>
                                                <div className="text-sm font-medium text-white">{session.subject}</div>
                                                <div className="text-xs text-slate-400">{session.date}</div>
                                            </div>
                                            <div className="text-sm font-semibold text-indigo-400">{session.duration}m</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                )}
                
                {activeTab === 'assignments' && (
                    <div className="space-y-4">
                        <div className="flex justify-end">
                            <button
                                onClick={() => {
                                    setEditingAssignment(null);
                                    setShowAssignmentModal(true);
                                }}
                                className="px-4 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-lg font-medium transition-colors"
                            >
                                + Add Assignment
                            </button>
                        </div>
                        
                        {pendingAssignments.length > 0 ? (
                            <div className="space-y-3">
                                {pendingAssignments.map(assignment => {
                                    const daysUntil = getDaysUntil(assignment.dueDate);
                                    return (
                                        <div key={assignment.id} className="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                                            <div className="flex items-start justify-between mb-2">
                                                <div className="flex-1">
                                                    <div className="flex items-center gap-2 mb-1">
                                                        <span className="text-lg">
                                                            {assignment.type === 'exam' ? 'ðŸ“' : 'ðŸ“„'}
                                                        </span>
                                                        <h4 className="text-sm font-semibold text-white">{assignment.title}</h4>
                                                    </div>
                                                    <div className="text-xs text-slate-400">{assignment.subject}</div>
                                                </div>
                                                <button
                                                    onClick={() => {
                                                        setEditingAssignment(assignment);
                                                        setShowAssignmentModal(true);
                                                    }}
                                                    className="text-slate-400 hover:text-white text-sm"
                                                >
                                                    Edit
                                                </button>
                                            </div>
                                            <div className="flex items-center justify-between mt-3">
                                                <span className={`text-xs font-medium ${getUrgencyColor(daysUntil)}`}>
                                                    {daysUntil < 0 ? 'Overdue' : daysUntil === 0 ? 'Due today' : `${daysUntil} days left`}
                                                </span>
                                                <div className="flex items-center gap-2">
                                                    <span className={`text-xs px-2 py-1 rounded ${
                                                        assignment.priority === 'high' ? 'bg-rose-500/20 text-rose-400' :
                                                        assignment.priority === 'medium' ? 'bg-amber-500/20 text-amber-400' :
                                                        'bg-slate-500/20 text-slate-400'
                                                    }`}>
                                                        {assignment.priority}
                                                    </span>
                                                    <button
                                                        onClick={() => {
                                                            dispatch({
                                                                type: ActionTypes.UPDATE_ASSIGNMENT,
                                                                payload: { id: assignment.id, updates: { status: 'completed' } }
                                                            });
                                                            showToast('Assignment completed! +30 XP', 'success');
                                                        }}
                                                        className="text-xs px-3 py-1 bg-emerald-500 hover:bg-emerald-600 text-white rounded transition-colors"
                                                    >
                                                        Complete
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        ) : (
                            <div className="bg-slate-800/50 rounded-xl p-6 border border-slate-700 text-center">
                                <div className="text-4xl mb-4">ðŸ“</div>
                                <h3 className="text-lg font-semibold text-white mb-2">No Assignments</h3>
                                <p className="text-slate-400 mb-4">Add your first assignment to get started</p>
                            </div>
                        )}
                    </div>
                )}
                
                {activeTab === 'timetable' && (
                    <div className="space-y-4">
                        <button
                            onClick={() => setShowTimetableModal(true)}
                            className="w-full py-3 bg-indigo-500 hover:bg-indigo-600 text-white rounded-xl font-medium transition-colors"
                        >
                            + Add Class
                        </button>
                        
                        {state.timetable.length > 0 ? (
                            <div className="space-y-3">
                                {['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'].map(day => {
                                    const dayClasses = state.timetable.filter(c => c.day === day).sort((a, b) => a.startTime.localeCompare(b.startTime));
                                    
                                    if (dayClasses.length === 0) return null;
                                    
                                    return (
                                        <div key={day} className="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                                            <h4 className="text-sm font-semibold text-slate-300 mb-3">{day}</h4>
                                            <div className="space-y-2">
                                                {dayClasses.map(cls => (
                                                    <div
                                                        key={cls.id}
                                                        className={`${cls.color} bg-opacity-20 border border-opacity-50 ${cls.color.replace('bg-', 'border-')} rounded-lg p-3`}
                                                    >
                                                        <div className="flex items-start justify-between">
                                                            <div className="flex-1">
                                                                <div className="font-medium text-white">{cls.subject}</div>
                                                                <div className="text-sm text-slate-300 mt-1">
                                                                    {cls.startTime} - {cls.endTime}
                                                                </div>
                                                                {cls.room && (
                                                                    <div className="text-sm text-slate-400 mt-1">
                                                                        ðŸ“ {cls.room}
                                                                    </div>
                                                                )}
                                                                {cls.notes && (
                                                                    <div className="text-sm text-slate-400 mt-1">
                                                                        ðŸ“ {cls.notes}
                                                                    </div>
                                                                )}
                                                            </div>
                                                            <div className="flex gap-2 ml-2">
                                                                <button
                                                                    onClick={() => {
                                                                        setEditingTimetable(cls);
                                                                        setShowTimetableModal(true);
                                                                    }}
                                                                    className="text-slate-400 hover:text-indigo-400 transition-colors"
                                                                >
                                                                    âœï¸
                                                                </button>
                                                                <button
                                                                    onClick={() => {
                                                                        if (confirm('Delete this class?')) {
                                                                            dispatch({ type: ActionTypes.DELETE_TIMETABLE_ENTRY, payload: { id: cls.id } });
                                                                            showToast('Class deleted', 'success');
                                                                        }
                                                                    }}
                                                                    className="text-slate-400 hover:text-rose-400 transition-colors"
                                                                >
                                                                    ðŸ—‘ï¸
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        ) : (
                            <div className="bg-slate-800/50 rounded-xl p-6 border border-slate-700 text-center">
                                <div className="text-4xl mb-4">ðŸ“…</div>
                                <h3 className="text-lg font-semibold text-white mb-2">No Classes</h3>
                                <p className="text-slate-400 mb-4">Add your first class to get started</p>
                            </div>
                        )}
                    </div>
                )}
                
                {/* Quick Stats */}
                <div className="grid grid-cols-2 gap-4">
                    <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                        <div className="text-2xl font-bold text-indigo-400">{Math.floor(todayStudyTime / 60)}h {todayStudyTime % 60}m</div>
                        <div className="text-sm text-slate-400">Today's Study Time</div>
                    </div>
                    <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                        <div className="text-2xl font-bold text-amber-400">{pendingAssignments.length}</div>
                        <div className="text-sm text-slate-400">Pending Tasks</div>
                    </div>
                </div>
                
                {/* Modals */}
                {showStudyTimer && <StudyTimer onClose={() => setShowStudyTimer(false)} />}
                {showAssignmentModal && (
                    <AssignmentModal
                        assignment={editingAssignment}
                        onClose={() => {
                            setShowAssignmentModal(false);
                            setEditingAssignment(null);
                        }}
                    />
                )}
                {showTimetableModal && (
                    <TimetableModal
                        entry={editingTimetable}
                        onClose={() => {
                            setShowTimetableModal(false);
                            setEditingTimetable(null);
                        }}
                    />
                )}
            </div>
        );
    });

    /**
     * Journal View - Daily journaling and mood tracking
     */
    const JournalView = memo(() => {
        const { state, dispatch } = useApp();
        const today = DateUtils.toKey();
        const todayEntry = state.journalEntries.find(e => e.date === today);
        const [showJournalModal, setShowJournalModal] = useState(false);
        const [showWellnessModal, setShowWellnessModal] = useState(null); // 'sleep', 'water', 'exercise', 'mood'
        
        // Calculate wellness stats
        const todayWater = state.waterLog[today] || 0;
        const todaySleep = state.sleepLog.find(s => s.date === today);
        const todayExercise = state.exerciseLog.filter(e => e.date === today);
        const todayMood = state.moodLog[today];
        const todayExerciseTime = todayExercise.reduce((sum, e) => sum + e.duration, 0);
        
        // Calculate journal streak
        const journalStreak = useMemo(() => {
            let streak = 0;
            let currentDate = new Date();
            
            while (true) {
                const dateKey = DateUtils.toKey(currentDate);
                const hasEntry = state.journalEntries.some(e => e.date === dateKey);
                
                if (!hasEntry) break;
                streak++;
                currentDate.setDate(currentDate.getDate() - 1);
            }
            
            return streak;
        }, [state.journalEntries]);
        
        return (
            <div className="space-y-6">
                {/* Header */}
                <div>
                    <h2 className="text-2xl font-bold text-white mb-2">ðŸ““ Daily Journal</h2>
                    <p className="text-slate-400 text-sm">Reflect on your day and track your wellness</p>
                </div>
                
                {/* Wellness Quick Stats */}
                <div className="grid grid-cols-4 gap-3">
                    <button
                        onClick={() => setShowWellnessModal('sleep')}
                        className="bg-slate-800/50 rounded-xl p-3 border border-slate-700 text-center hover:bg-slate-800 transition-colors"
                    >
                        <div className="text-2xl mb-1">ðŸ’¤</div>
                        <div className="text-xs text-slate-400">Sleep</div>
                        <div className="text-sm font-semibold text-white">
                            {todaySleep ? `${todaySleep.hours}h` : '-'}
                        </div>
                    </button>
                    <button
                        onClick={() => setShowWellnessModal('water')}
                        className="bg-slate-800/50 rounded-xl p-3 border border-slate-700 text-center hover:bg-slate-800 transition-colors"
                    >
                        <div className="text-2xl mb-1">ðŸ’§</div>
                        <div className="text-xs text-slate-400">Water</div>
                        <div className="text-sm font-semibold text-white">{todayWater}/{state.waterGoal}</div>
                    </button>
                    <button
                        onClick={() => setShowWellnessModal('exercise')}
                        className="bg-slate-800/50 rounded-xl p-3 border border-slate-700 text-center hover:bg-slate-800 transition-colors"
                    >
                        <div className="text-2xl mb-1">ðŸƒ</div>
                        <div className="text-xs text-slate-400">Exercise</div>
                        <div className="text-sm font-semibold text-white">{todayExerciseTime}m</div>
                    </button>
                    <button
                        onClick={() => setShowWellnessModal('mood')}
                        className="bg-slate-800/50 rounded-xl p-3 border border-slate-700 text-center hover:bg-slate-800 transition-colors"
                    >
                        <div className="text-2xl mb-1">{todayMood?.mood ? CONFIG.MOODS[todayMood.mood] : 'ðŸ˜'}</div>
                        <div className="text-xs text-slate-400">Mood</div>
                        <div className="text-sm font-semibold text-white">
                            {todayMood ? `${todayMood.energy}/5` : '-'}
                        </div>
                    </button>
                </div>
                
                {/* Journal Entry */}
                <div className="bg-slate-800/50 rounded-xl p-6 border border-slate-700">
                    {todayEntry ? (
                        <div>
                            <div className="flex items-center justify-between mb-4">
                                <div className="flex items-center gap-3">
                                    <span className="text-2xl">{CONFIG.MOODS[todayEntry.mood]}</span>
                                    <div>
                                        <h3 className="text-lg font-semibold text-white">Today's Entry</h3>
                                        <p className="text-xs text-slate-400">{todayEntry.wordCount} words</p>
                                    </div>
                                </div>
                                <button
                                    onClick={() => setShowJournalModal(true)}
                                    className="text-indigo-400 hover:text-indigo-300 text-sm font-medium"
                                >
                                    Edit
                                </button>
                            </div>
                            <p className="text-slate-300 whitespace-pre-wrap mb-3">{todayEntry.content}</p>
                            {todayEntry.gratitude && (
                                <div className="bg-indigo-500/10 rounded-lg p-3 border border-indigo-500/20">
                                    <div className="text-xs text-indigo-400 font-medium mb-1">Grateful for:</div>
                                    <div className="text-sm text-white">{todayEntry.gratitude}</div>
                                </div>
                            )}
                        </div>
                    ) : (
                        <div className="text-center py-8">
                            <div className="text-4xl mb-4">âœï¸</div>
                            <h3 className="text-lg font-semibold text-white mb-2">No Entry Yet</h3>
                            <p className="text-slate-400 mb-4">Start journaling to track your thoughts and progress</p>
                            <button
                                onClick={() => setShowJournalModal(true)}
                                className="px-6 py-3 bg-indigo-500 hover:bg-indigo-600 text-white rounded-xl font-medium transition-colors"
                            >
                                Write Entry
                            </button>
                        </div>
                    )}
                </div>
                
                {/* Streak & Recent Entries */}
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div className="bg-gradient-to-br from-purple-500/10 to-indigo-500/10 rounded-xl p-4 border border-purple-500/20">
                        <div className="flex items-center justify-between">
                            <div>
                                <div className="text-2xl font-bold text-purple-400">{journalStreak} days</div>
                                <div className="text-sm text-slate-400">Journal Streak</div>
                            </div>
                            <div className="text-4xl">ðŸ”¥</div>
                        </div>
                    </div>
                    
                    <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                        <div className="text-sm font-semibold text-white mb-2">Total Entries</div>
                        <div className="text-2xl font-bold text-indigo-400">{state.journalEntries.length}</div>
                    </div>
                </div>
                
                {/* Recent Entries */}
                {state.journalEntries.length > 1 && (
                    <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                        <h4 className="text-sm font-semibold text-white mb-3">Recent Entries</h4>
                        <div className="space-y-2">
                            {state.journalEntries
                                .sort((a, b) => new Date(b.date) - new Date(a.date))
                                .slice(1, 6)
                                .map(entry => (
                                    <div key={entry.id} className="flex items-center justify-between py-2 border-b border-slate-700 last:border-0">
                                        <div className="flex items-center gap-3">
                                            <span className="text-xl">{CONFIG.MOODS[entry.mood]}</span>
                                            <div>
                                                <div className="text-sm font-medium text-white">{entry.date}</div>
                                                <div className="text-xs text-slate-400">{entry.wordCount} words</div>
                                            </div>
                                        </div>
                                        <button className="text-xs text-indigo-400 hover:text-indigo-300">View</button>
                                    </div>
                                ))}
                        </div>
                    </div>
                )}
                
                {/* Modals */}
                {showJournalModal && (
                    <JournalEntryModal
                        entry={todayEntry}
                        onClose={() => setShowJournalModal(false)}
                    />
                )}
                {showWellnessModal && (
                    <WellnessModal
                        type={showWellnessModal}
                        onClose={() => setShowWellnessModal(null)}
                    />
                )}
            </div>
        );
    });

    /**
     * Expense Modal - Add/Edit Expense
     */
    const ExpenseModal = memo(({ expense, onClose }) => {
        const { state, dispatch } = useApp();
        const [amount, setAmount] = useState(expense?.amount || '');
        const [category, setCategory] = useState(expense?.category || state.expenseCategories[0]);
        const [description, setDescription] = useState(expense?.description || '');
        const [date, setDate] = useState(expense?.date || DateUtils.toKey());
        
        const handleSubmit = (e) => {
            e.preventDefault();
            if (!amount || parseFloat(amount) <= 0) return;
            
            if (expense) {
                dispatch({
                    type: ActionTypes.UPDATE_EXPENSE,
                    payload: {
                        id: expense.id,
                        updates: {
                            amount: parseFloat(amount),
                            category,
                            description: description.trim(),
                            date
                        }
                    }
                });
                showToast('Expense updated', 'success');
            } else {
                dispatch({
                    type: ActionTypes.ADD_EXPENSE,
                    payload: {
                        amount: parseFloat(amount),
                        category,
                        description: description.trim(),
                        date
                    }
                });
                showToast('Expense tracked! +2 XP', 'success');
            }
            onClose();
        };
        
        return (
            <div className="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/60 backdrop-blur-sm">
                <div className="w-full sm:max-w-md bg-slate-900 rounded-t-3xl sm:rounded-2xl p-6 border border-slate-700">
                    <h3 className="text-xl font-bold text-white mb-4">
                        {expense ? 'Edit Expense' : 'ðŸ’° Add Expense'}
                    </h3>
                    
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-2">Amount *</label>
                            <div className="relative">
                                <span className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400">$</span>
                                <input
                                    type="number"
                                    step="0.01"
                                    min="0"
                                    value={amount}
                                    onChange={(e) => setAmount(e.target.value)}
                                    placeholder="0.00"
                                    className="w-full pl-8 pr-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white"
                                    required
                                />
                            </div>
                        </div>
                        
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-2">Category</label>
                            <select
                                value={category}
                                onChange={(e) => setCategory(e.target.value)}
                                className="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white"
                            >
                                {state.expenseCategories.map(cat => (
                                    <option key={cat} value={cat}>{cat}</option>
                                ))}
                            </select>
                        </div>
                        
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-2">Description</label>
                            <input
                                type="text"
                                value={description}
                                onChange={(e) => setDescription(e.target.value)}
                                placeholder="e.g., Lunch at cafeteria"
                                className="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white"
                            />
                        </div>
                        
                        <div>
                            <label className="block text-sm font-medium text-slate-300 mb-2">Date</label>
                            <input
                                type="date"
                                value={date}
                                onChange={(e) => setDate(e.target.value)}
                                className="w-full px-4 py-3 bg-slate-800 border border-slate-700 rounded-xl text-white"
                            />
                        </div>
                        
                        <div className="flex gap-3 pt-4">
                            <button
                                type="button"
                                onClick={onClose}
                                className="flex-1 py-3 bg-slate-800 hover:bg-slate-700 rounded-xl text-white font-medium transition-colors"
                            >
                                Cancel
                            </button>
                            <button
                                type="submit"
                                className="flex-1 py-3 bg-indigo-500 hover:bg-indigo-600 rounded-xl text-white font-medium transition-colors"
                            >
                                {expense ? 'Update' : 'Add'}
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        );
    });

    /**
     * Expense Tracker View
     */
    const ExpenseView = memo(() => {
        const { state, dispatch } = useApp();
        const [showExpenseModal, setShowExpenseModal] = useState(false);
        const [editingExpense, setEditingExpense] = useState(null);
        const [timeFilter, setTimeFilter] = useState('month'); // day, week, month
        
        // Calculate filtered expenses
        const filteredExpenses = useMemo(() => {
            const now = new Date();
            const today = DateUtils.toKey();
            
            return state.expenses.filter(e => {
                if (timeFilter === 'day') return e.date === today;
                if (timeFilter === 'week') {
                    const expenseDate = new Date(e.date);
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    return expenseDate >= weekAgo;
                }
                if (timeFilter === 'month') {
                    const expenseDate = new Date(e.date);
                    return expenseDate.getMonth() === now.getMonth() && 
                           expenseDate.getFullYear() === now.getFullYear();
                }
                return true;
            }).sort((a, b) => new Date(b.date) - new Date(a.date));
        }, [state.expenses, timeFilter]);
        
        // Calculate total and category breakdown
        const stats = useMemo(() => {
            const total = filteredExpenses.reduce((sum, e) => sum + e.amount, 0);
            const byCategory = {};
            
            filteredExpenses.forEach(e => {
                byCategory[e.category] = (byCategory[e.category] || 0) + e.amount;
            });
            
            return { total, byCategory };
        }, [filteredExpenses]);
        
        const budgetRemaining = state.monthlyBudget - stats.total;
        const budgetPercentage = (stats.total / state.monthlyBudget) * 100;
        
        const getCategoryIcon = (category) => {
            const icons = {
                'Food': 'ðŸ”',
                'Transport': 'ðŸš—',
                'Books': 'ðŸ“š',
                'Entertainment': 'ðŸŽ®',
                'Subscriptions': 'ðŸ’³',
                'Health': 'âš•ï¸',
                'Other': 'ðŸ“¦'
            };
            return icons[category] || 'ðŸ’°';
        };
        
        return (
            <div className="space-y-6">
                {/* Header */}
                <div>
                    <h2 className="text-2xl font-bold text-white mb-2">ðŸ’° Expense Tracker</h2>
                    <p className="text-slate-400 text-sm">Track your spending and stay within budget</p>
                </div>
                
                {/* Budget Overview */}
                <div className="bg-gradient-to-br from-emerald-500/10 to-cyan-500/10 rounded-xl p-6 border border-emerald-500/20">
                    <div className="flex items-center justify-between mb-3">
                        <div>
                            <div className="text-sm text-slate-400 mb-1">Monthly Budget</div>
                            <div className="text-3xl font-bold text-white">${stats.total.toFixed(2)}</div>
                            <div className="text-sm text-slate-400">of ${state.monthlyBudget}</div>
                        </div>
                        <div className="text-right">
                            <div className="text-sm text-slate-400 mb-1">Remaining</div>
                            <div className={`text-2xl font-bold ${
                                budgetRemaining >= 0 ? 'text-emerald-400' : 'text-rose-400'
                            }`}>
                                ${Math.abs(budgetRemaining).toFixed(2)}
                            </div>
                        </div>
                    </div>
                    
                    {/* Progress Bar */}
                    <div className="bg-slate-800 rounded-full h-3 overflow-hidden">
                        <div
                            className={`h-full transition-all duration-500 ${
                                budgetPercentage >= 100 ? 'bg-rose-500' :
                                budgetPercentage >= 80 ? 'bg-amber-500' :
                                'bg-emerald-500'
                            }`}
                            style={{ width: `${Math.min(budgetPercentage, 100)}%` }}
                        />
                    </div>
                    <div className="text-xs text-slate-400 mt-1 text-right">{budgetPercentage.toFixed(0)}% used</div>
                </div>
                
                {/* Time Filter */}
                <div className="flex gap-2 bg-slate-800/50 p-1 rounded-xl">
                    {[
                        { id: 'day', label: 'Today' },
                        { id: 'week', label: 'Week' },
                        { id: 'month', label: 'Month' }
                    ].map(filter => (
                        <button
                            key={filter.id}
                            onClick={() => setTimeFilter(filter.id)}
                            className={`flex-1 py-2 rounded-lg text-sm font-medium transition-all ${
                                timeFilter === filter.id
                                    ? 'bg-indigo-500 text-white'
                                    : 'text-slate-400 hover:text-white'
                            }`}
                        >
                            {filter.label}
                        </button>
                    ))}
                </div>
                
                {/* Category Breakdown */}
                {Object.keys(stats.byCategory).length > 0 && (
                    <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                        <h4 className="text-sm font-semibold text-white mb-3">Category Breakdown</h4>
                        <div className="space-y-2">
                            {Object.entries(stats.byCategory)
                                .sort(([, a], [, b]) => b - a)
                                .map(([category, amount]) => (
                                    <div key={category} className="flex items-center gap-3">
                                        <span className="text-xl">{getCategoryIcon(category)}</span>
                                        <div className="flex-1">
                                            <div className="flex items-center justify-between mb-1">
                                                <span className="text-sm text-white">{category}</span>
                                                <span className="text-sm font-semibold text-white">${amount.toFixed(2)}</span>
                                            </div>
                                            <div className="bg-slate-700 rounded-full h-1.5 overflow-hidden">
                                                <div
                                                    className="h-full bg-indigo-500"
                                                    style={{ width: `${(amount / stats.total) * 100}%` }}
                                                />
                                            </div>
                                        </div>
                                    </div>
                                ))}
                        </div>
                    </div>
                )}
                
                {/* Add Expense Button */}
                <button
                    onClick={() => {
                        setEditingExpense(null);
                        setShowExpenseModal(true);
                    }}
                    className="w-full py-3 bg-indigo-500 hover:bg-indigo-600 text-white rounded-xl font-medium transition-colors"
                >
                    + Add Expense
                </button>
                
                {/* Recent Expenses */}
                {filteredExpenses.length > 0 ? (
                    <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                        <h4 className="text-sm font-semibold text-white mb-3">Recent Expenses</h4>
                        <div className="space-y-2">
                            {filteredExpenses.slice(0, 10).map(expense => (
                                <div key={expense.id} className="flex items-center justify-between py-2 border-b border-slate-700 last:border-0">
                                    <div className="flex items-center gap-3">
                                        <span className="text-xl">{getCategoryIcon(expense.category)}</span>
                                        <div>
                                            <div className="text-sm font-medium text-white">
                                                {expense.description || expense.category}
                                            </div>
                                            <div className="text-xs text-slate-400">{expense.date}</div>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        <span className="text-sm font-semibold text-white">${expense.amount.toFixed(2)}</span>
                                        <button
                                            onClick={() => {
                                                setEditingExpense(expense);
                                                setShowExpenseModal(true);
                                            }}
                                            className="text-xs text-indigo-400 hover:text-indigo-300"
                                        >
                                            Edit
                                        </button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                ) : (
                    <div className="bg-slate-800/50 rounded-xl p-6 border border-slate-700 text-center">
                        <div className="text-4xl mb-4">ðŸ’°</div>
                        <h3 className="text-lg font-semibold text-white mb-2">No Expenses Yet</h3>
                        <p className="text-slate-400">Start tracking your spending to stay within budget</p>
                    </div>
                )}
                
                {/* Modal */}
                {showExpenseModal && (
                    <ExpenseModal
                        expense={editingExpense}
                        onClose={() => {
                            setShowExpenseModal(false);
                            setEditingExpense(null);
                        }}
                    />
                )}
            </div>
        );
    });

    // ============================================================================
    // SECTION 9: MAIN APP COMPONENT
    // ============================================================================

    /**
     * Main Application Component
     */
    const App = () => {
        const [state, dispatch] = useReducer(appReducer, null, createInitialState);
        const [showAddModal, setShowAddModal] = useState(false);
        const isOnline = useOnlineStatus();
        
        // Load persisted state
        useLoadState(dispatch);
        
        // Persist state changes
        usePersistedState(state, state.isLoading);
        
        // Keyboard shortcuts
        useKeyboardShortcuts(dispatch, state);
        
        // View components
        const viewComponents = {
            dashboard: DashboardPage,
            study: StudyView,
            analytics: AnalyticsView,
            journal: JournalView,
            expenses: ExpenseView,
            settings: SettingsView,
            matrix: MatrixView // Keep matrix for backward compatibility
        };
        
        const CurrentView = viewComponents[state.view] || DashboardPage;
        
        // Loading state
        if (state.isLoading) {
            return (
                <div className="min-h-screen bg-slate-950 flex items-center justify-center">
                    <div className="text-center">
                        <div className="w-16 h-16 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin mx-auto mb-4" />
                        <p className="text-slate-400">Loading your habits...</p>
                    </div>
                </div>
            );
        }
        
        return (
            <AppContext.Provider value={{ state, dispatch }}>
                <div className="min-h-screen bg-slate-950 text-white">
                    {/* Offline Banner */}
                    {!isOnline && (
                        <div 
                            className="bg-amber-600 text-white text-center py-2 text-sm"
                            role="alert"
                        >
                            ðŸ“´ You're offline. Changes are saved locally.
                        </div>
                    )}
                    
                    {/* Header */}
                    <header className="sticky top-0 z-40 bg-slate-900/95 backdrop-blur-lg border-b border-slate-800">
                        <div className="max-w-2xl mx-auto px-4 py-3">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl flex items-center justify-center text-xl shadow-lg shadow-indigo-500/20">
                                        ðŸ“š
                                    </div>
                                    <div>
                                        <h1 className="font-bold text-white text-lg">{CONFIG.APP_NAME}</h1>
                                        <p className="text-xs text-slate-400">
                                            {DateUtils.format(new Date(), { weekday: 'long', month: 'short', day: 'numeric' })}
                                        </p>
                                    </div>
                                </div>
                                
                                <div className="flex items-center gap-2">
                                    {/* XP/Level Indicator */}
                                    <div className="hidden sm:flex flex-col items-end">
                                        <div className="text-xs text-indigo-400 font-semibold">
                                            Level {state.level}
                                        </div>
                                        <div className="text-xs text-slate-500">
                                            {state.xp} XP
                                        </div>
                                    </div>
                                    
                                    {/* Undo/Redo Buttons */}
                                    <div className="flex items-center gap-1">
                                        <IconButton
                                            icon="â†©ï¸"
                                            label="Undo (Ctrl+Z)"
                                            onClick={() => {
                                                dispatch({ type: ActionTypes.UNDO });
                                                showToast('Undone');
                                            }}
                                            disabled={state.undoStack.length === 0}
                                            size="sm"
                                        />
                                        <IconButton
                                            icon="â†ªï¸"
                                            label="Redo (Ctrl+Shift+Z)"
                                            onClick={() => {
                                                dispatch({ type: ActionTypes.REDO });
                                                showToast('Redone');
                                            }}
                                            disabled={state.redoStack.length === 0}
                                            size="sm"
                                        />
                                    </div>
                                </div>
                            </div>
                            
                            {/* XP Progress Bar */}
                            <div className="mt-2 bg-slate-800 rounded-full h-1.5 overflow-hidden">
                                <div 
                                    className="h-full bg-gradient-to-r from-indigo-500 to-purple-500 transition-all duration-500"
                                    style={{ 
                                        width: `${((state.xp % (state.level * state.level * CONFIG.XP_PER_LEVEL)) / (state.level * state.level * CONFIG.XP_PER_LEVEL)) * 100}%` 
                                    }}
                                />
                            </div>
                        </div>
                    </header>
                    
                    {/* Main Content */}
                    <main 
                        id="main-content"
                        className="max-w-2xl mx-auto px-4 py-6 pb-32"
                        role="main"
                    >
                        <CurrentView />
                    </main>
                    
                    {/* Bottom Navigation */}
                    <nav 
                        className="fixed bottom-0 left-0 right-0 bg-slate-900/95 backdrop-blur-lg border-t border-slate-800 z-40"
                        role="navigation"
                        aria-label="Main navigation"
                    >
                        <div className="max-w-2xl mx-auto px-2">
                            <div className="flex items-center justify-around py-2">
                                {[
                                    { id: 'dashboard', icon: 'ðŸ“‹', label: 'Home' },
                                    { id: 'study', icon: 'ðŸ“š', label: 'Study' },
                                    { id: 'analytics', icon: 'ðŸ“Š', label: 'Stats' },
                                    { id: 'journal', icon: 'ðŸ““', label: 'Journal' },
                                    { id: 'settings', icon: 'âš™ï¸', label: 'Settings' }
                                ].map((item) => (
                                    <button
                                        key={item.id}
                                        onClick={() => dispatch({ type: ActionTypes.SET_VIEW, payload: item.id })}
                                        className={`flex flex-col items-center gap-1 px-3 py-2 rounded-xl transition-all touch-target ${
                                            state.view === item.id
                                                ? 'text-indigo-400 bg-indigo-500/10'
                                                : 'text-slate-400 hover:text-slate-200'
                                        }`}
                                        aria-current={state.view === item.id ? 'page' : undefined}
                                        aria-label={item.label}
                                    >
                                        <span className="text-xl" aria-hidden="true">{item.icon}</span>
                                        <span className="text-xs font-medium">{item.label}</span>
                                    </button>
                                ))}
                            </div>
                        </div>
                        
                        {/* Safe area padding for devices with home indicator */}
                        <div className="h-[env(safe-area-inset-bottom)]" />
                    </nav>
                    
                    {/* Floating Action Button (only on dashboard) */}
                    {state.view === 'dashboard' && (
                        <button
                            onClick={() => setShowAddModal(true)}
                            className="fixed bottom-24 right-6 w-14 h-14 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-full shadow-lg shadow-indigo-500/30 flex items-center justify-center transition-all hover:scale-110 active:scale-95 z-30 touch-target"
                            aria-label="Add new habit"
                        >
                            <span className="text-2xl text-white" aria-hidden="true">+</span>
                        </button>
                    )}
                    
                    {/* Global Add Modal */}
                    {showAddModal && (
                        <HabitModal onClose={() => setShowAddModal(false)} />
                    )}
                </div>
            </AppContext.Provider>
        );
    };

    // ============================================================================
    // SECTION 10: APP INITIALIZATION
    // ============================================================================

    // Mount the application
    const rootElement = document.getElementById('root');
    const root = ReactDOM.createRoot(rootElement);
    
    // Error boundary wrapper
    class ErrorBoundary extends React.Component {
        constructor(props) {
            super(props);
            this.state = { hasError: false, error: null };
        }
        
        static getDerivedStateFromError(error) {
            return { hasError: true, error };
        }
        
        componentDidCatch(error, errorInfo) {
            console.error('App Error:', error, errorInfo);
        }
        
        render() {
            if (this.state.hasError) {
                return (
                    <div className="min-h-screen bg-slate-950 flex items-center justify-center p-4">
                        <div className="text-center max-w-md">
                            <div className="text-6xl mb-4">ðŸ˜µ</div>
                            <h1 className="text-xl font-bold text-white mb-2">Something went wrong</h1>
                            <p className="text-slate-400 text-sm mb-6">
                                The app encountered an error. Your data is safe in local storage.
                            </p>
                            <button
                                onClick={() => window.location.reload()}
                                className="px-6 py-3 bg-indigo-600 hover:bg-indigo-500 rounded-xl text-white font-medium transition-colors"
                            >
                                Reload App
                            </button>
                            <details className="mt-6 text-left">
                                <summary className="text-slate-500 text-xs cursor-pointer">
                                    Error details
                                </summary>
                                <pre className="mt-2 p-3 bg-slate-800 rounded-lg text-xs text-rose-400 overflow-auto">
                                    {this.state.error?.toString()}
                                </pre>
                            </details>
                        </div>
                    </div>
                );
            }
            
            return this.props.children;
        }
    }
    
    // Render with error boundary
    root.render(
        <ErrorBoundary>
            <App />
        </ErrorBoundary>
    );
    
    // ============================================================================
    // SECTION 11: SERVICE WORKER & PWA SETUP
    // ============================================================================
    
    // Register service worker for offline support
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', async () => {
            try {
                // Create inline service worker
                const swCode = `
                    const CACHE_NAME = 'habitos-v${CONFIG.VERSION}';
                    const OFFLINE_URL = '/';
                    
                    self.addEventListener('install', (event) => {
                        event.waitUntil(
                            caches.open(CACHE_NAME).then((cache) => {
                                return cache.addAll([
                                    '/',
                                    'https://cdn.tailwindcss.com',
                                    'https://unpkg.com/react@18/umd/react.production.min.js',
                                    'https://unpkg.com/react-dom@18/umd/react-dom.production.min.js'
                                ]);
                            })
                        );
                        self.skipWaiting();
                    });
                    
                    self.addEventListener('activate', (event) => {
                        event.waitUntil(
                            caches.keys().then((names) => {
                                return Promise.all(
                                    names.filter((name) => name !== CACHE_NAME)
                                         .map((name) => caches.delete(name))
                                );
                            })
                        );
                        self.clients.claim();
                    });
                    
                    self.addEventListener('fetch', (event) => {
                        event.respondWith(
                            caches.match(event.request).then((cached) => {
                                return cached || fetch(event.request).catch(() => {
                                    if (event.request.mode === 'navigate') {
                                        return caches.match(OFFLINE_URL);
                                    }
                                });
                            })
                        );
                    });
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                await navigator.serviceWorker.register(swUrl);
                console.log('Service Worker registered');
            } catch (error) {
                console.log('Service Worker registration skipped:', error.message);
            }
        });
    }
    
    // Install prompt handling
    let deferredPrompt = null;
    
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        
        // Check if user hasn't dismissed recently
        const lastDismissed = localStorage.getItem('install-prompt-dismissed');
        const daysSinceDismissed = lastDismissed 
            ? (Date.now() - parseInt(lastDismissed)) / (1000 * 60 * 60 * 24)
            : Infinity;
        
        if (daysSinceDismissed > 7) {
            // Show install prompt after 30 seconds of usage
            setTimeout(() => {
                if (deferredPrompt && confirm('Install HabitOS for quick access and offline support?')) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choice) => {
                        if (choice.outcome === 'accepted') {
                            showToast('App installed! ðŸŽ‰', 'success');
                        }
                        deferredPrompt = null;
                    });
                } else {
                    localStorage.setItem('install-prompt-dismissed', Date.now().toString());
                }
            }, 30000);
        }
    });
    
    window.addEventListener('appinstalled', () => {
        console.log('App installed');
        deferredPrompt = null;
    });
    
    </script>
</body>
</html>